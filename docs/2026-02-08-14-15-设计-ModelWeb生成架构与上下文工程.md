# 设计：Model Web 生成架构与上下文工程 (v2)

## 1. 背景与目标 (v2)

本设计文档旨在重新定义 Model Web 的生成逻辑。基于用户反馈，我们采用了更稳健的 **双 Graph 架构**，并引入了 **“样本驱动 (Example-Driven)”** 的上下文工程策略，以确保模型在特定技术栈（HTML/Tailwind, React）下能生成可运行、高质量的代码。

## 2. 核心架构：双 Graph 策略

我们将生成过程拆分为两个独立的 LangGraph：

### 2.1 Graph 1: Initial Generation (从零构建)
当用户首次发起请求（或明确要求重新开始）时触发。
**流程**: `User Input` -> `Idea Expander` -> `Style Director` -> `Code Generator` -> `End`

### 2.2 Graph 2: Refinement (迭代修改)
当当前 Session 已有生成的网页，且用户提出修改意见时触发。
**流程**: `User Feedback` -> `Editor` -> `End`

---

## 3. 详细节点设计与上下文工程

### 3.1 核心输入定义

本系统接收以下三类核心输入：
1.  **用户 Prompt**: 用户的原始意图描述。
2.  **设计选项 (DesignOption)**: 用户在 UI 面板中选择的视觉风格预设。
3.  **技术栈选项 (TechStackOption)**: 用户选择的底层实现框架（如 HTML+Tailwind 或 React）。

### 3.2 核心数据结构

```typescript
/**
 * 设计选项的选择
 */
type DesignOption = {
  name: string;                // 显示的名字 (e.g., "Swiss International")
  icon: string;                // 显示的图标 (Lucide icon name)
  description_general: string; // 给模型的整体风格描述
  description_color: string;   // 给模型的色彩指导 (Node A)
  description_shape: string;   // 给模型的样式/形状指导 (Node A)
  description_font: string;    // 给模型的字体指导 (Node A)
}

/**
 * 技术栈的选择
 */
type TechStackOption = {
  name: string;                 // 显示的名字 (e.g., "HTML + Tailwind")
  description_style: string;    // 给设计风格 (Node A) 的技术限制或建议
  description_expander: string; // 给充实方案 (Node B) 的结构或依赖建议
}
```


### 节点 A: 设计风格 (Style Director)
- **职责**: 根据需求和用户选择的风格（或默认），制定详细的视觉规范。
- **输入**: 需求描述 (From Node A)
- **Context 注入**: `Aesthetic Definitions` (美学定义库)。
- **System Prompt 重点**:
    - 角色：视觉总监。
    - 目标：输出具体的配色方案（Hex Codes）、字体选择（Google Fonts URL）、圆角/间距规范。
    - **关键**: 必须输出符合 Tailwind 规范的类名建议（如 `rounded-xl`, `gap-8`, `bg-stone-50`）。
- **输出**: Visual Design Spec (JSON/Markdown)。

#### 示例：节点 A 上下文与输出

**输入上下文**:
- **System Prompt (Template)**: "You are a Design Director. Translate the product idea into a visual system."
- **Selected Design (Swiss)**: "General: Swiss Style. Colors: Red accent on white/gray. Shape: Sharp corners. Font: Bold sans-serif."
- **User Prompt**: "A modern architectural firm landing page."
- **Tech Stack Constraint**: "Use Tailwind utility classes. No custom CSS."

**上下文组装**:

```typescript

const templateA = `

You are a Design Director. Your job is to translate the product idea into a coherent visual system.

Design Guide: ${selected_design.description_general}
Colors: ${selected_design.description_color}
Shapes: ${selected_design.description_shape}
Fonts: ${selected_design.description_font}
User requirements: ${user_prompt}

You should output a markdown document with the following sections exactly:
1. Color Palette: Define background, foreground, primary accent colors in Hex.
2. Style Tokens: Define border radius, border styles, shadow styles using Tailwind classes.
3. Typography: Suggest font family and Google Fonts URL.
4. Layout Logic: Describe the overall layout style (e.g., grid, asymmetric, heavy typography).
5. Decorative Elements: Suggest any additional visual elements (border, shadow, icons, patterns) if relevant.

<output_example>
## Color Palette
color should be pop and modern.
- Background Color, used on major background: ...
......
## Style Tokens
style tokens should reflect sharp and clean aesthetics.
- Primary border radius: ...
...
## Typography
...
## Layout Logic
...
## Decorative Elements
...
</output_example>
`;

```

**节点 A 输出 (Design Spec)**:
```json
{
  "color_palette": {
    "background": "#FFFFFF",
    "foreground": "#1A1A1A",
    "primary_accent": "#FF0000"
  },
  "style_tokens": {
    "radius": "rounded-none",
    "border": "border-2 border-black",
    "shadow": "shadow-none"
  },
  "typography": {
    "font_family": "Inter, sans-serif",
    "google_fonts_url": "https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap"
  },
  "layout_logic": "Asymmetric grid with heavy typography and high contrast."
}
```

```markdown
## Color Palette
color should be pop and modern.
- Background Color: #FFFFFF
- Foreground Color: #1A1A1A
## Style Tokens
style tokens should reflect sharp and clean aesthetics.
- Primary border radius: rounded-none
- Primary border style: border-2 border-black
- Primary shadow style: shadow-none
## Typography
use bold and clean sans-serif fonts.
- Font Family: Inter, sans-serif
## Layout Logic
asymmetric grid with heavy typography and high contrast.
## Decorative Elements
minimalist icons from Lucide, no extra patterns.
```

### 节点 B: 充实方案 (Idea Expander)
- **职责**: 将用户简短的 prompt 扩展为详细的产品需求文档。
- **输入**: User Prompt + TechStackOption.description_expander.
- **输出**: 结构化的需求描述 (Markdown)。

#### 示例：节点 B 上下文与输出

**输入上下文**:
- **System Prompt (Template)**: "You are a Product Manager. Expand the user's brief idea into a structured product requirement."
- **User Prompt**: "A modern architectural firm landing page."
- **Tech Stack**: "Structure as a single semantic HTML5 file using Lucide icons for visual aids."

**上下文组装**:

```typescript
const templateB = `
You are a Product Manager at a high-end web studio. Your job is to expand a short user request into a comprehensive Product Requirements Document (PRD).

User Prompt: ${user_prompt}
Technical Constraints: ${selected_tech_stack.description_expander}

You should output a markdown document with the following sections:
1. Page Concept: A 2-3 sentence overview of the site's purpose and "vibe".
2. Content Structure: Define the sections of the page (e.g., Hero, Projects, Services, Contact).
3. Detailed Copy: For each section, provide specific headlines and body text ideas.
4. Component Needs: List specific interactive or UI components needed (e.g., "Sticky Nav with glassmorphism", "Asymmetric project grid").
5. Icon & Imagery Strategy: Suggest specific Lucide icon names and Unsplash search keywords for imagery.

<output_example>
# Product Plan: [Project Name]
## Page Concept
...
## Content Structure
- Section 1: ...
...
## Detailed Copy
...
</output_example>
`;
```

**节点 B 输出 (Product Plan)**:

```markdown
# Product Plan: Axis Architecture

## Page Concept
A sophisticated, high-end landing page for a modern architectural firm. The "vibe" is cold, professional, and minimalist, emphasizing whitespace and geometric precision.

## Content Structure
- **Global Navigation**: Fixed header with minimal links and a high-contrast CTA.
- **Hero Section**: Large-scale monochrome architectural image with bold typography overlap.
- **Projects Showcase**: A 2x2 asymmetric grid of featured works.
- **Studio Philosophy**: A text-heavy section explaining the "Designing Silence" approach.
- **Contact Footer**: Simple contact info and social links with a monochrome map placeholder.

## Detailed Copy
- **Hero Headline**: "Designing Silence."
- **Hero Subheader**: "We believe architecture is the art of organizing light and shadow."
- **Philosophy Title**: "Precision in Every Line."

## Component Needs
- Sticky header with `backdrop-blur-md` and a thin black border.
- `ProjectCard`: Hover state that slightly darkens the image and reveals the project name.
- CTA Button: No rounded corners, solid black background, white text.

## Icon & Imagery Strategy
- Icons: `lucide-arrow-right`, `lucide-map-pin`, `lucide-layers`.
- Imagery: "Monochrome brutalist architecture", "Modern concrete stairs", "Minimalist glass facade".
```


### 节点 C: 具体生成 (Code Generator)
- **职责**: 综合需求和视觉规范，编写可执行代码。
- **输入**: 需求文档 (From Node B) + 视觉规范 (From Node A) + TechStack Boilerplate.
- **输出**: 工具调用 `write_file(path, content)`。

#### 示例：节点 C 上下文与输出

**输入上下文**:
- **System Prompt**: "You are a Senior Frontend Developer. Combine the Visual Spec and Product Plan into a functional HTML/CSS/JS file."
- **Visual Spec (Node A Output)**: (包含配色、字体、样式 Token 的 Markdown 文档)
- **Product Plan (Node B Output)**: (包含页面结构、内容文案的需求文档)
- **Tech Stack Boilerplate**: (HTML+Tailwind 基础骨架)
- **Protocol**: "Use delimited blocks: `=== write: path ===` followed by content."

**上下文组装**:

```typescript
const templateC = `
You are a Senior Frontend Developer. Your mission is to implement a complete, beautiful, and functional website based on the provided Design Spec and Product Plan.

### 1. PRODUCT PLAN (Requirements)
${node_b_output}

### 2. VISUAL SPEC (Design)
${node_a_output}

### 3. TECHNICAL CONSTRAINTS
- Use the following Boilerplate EXACTLY. Do NOT remove CDN links or the Icon initialization script.
- Tech Stack: ${selected_tech_stack.boilerplate_code}

### 4. INSTRUCTIONS
- Write the final code to "/index.html" using the VFS protocol.
- Map the "Style Tokens" from the Visual Spec to Tailwind classes in your code (e.g., if Spec says "rounded-none", use it for all containers).
- Use the primary accent color for key elements like buttons and icons.
- Ensure the copy from the Product Plan is accurately reflected.
- Use Lucide icons correctly: <i data-lucide="coffee"></i>.

### PROTOCOL (CRITICAL)
=== write: [file_path] ===
[Content]
`;
```

**节点 C 输出 (Code Generation)**:

```text
I will now implement the architecture firm landing page using the Swiss-inspired visual system.

=== write: /index.html ===
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hero-title { line-height: 0.8; letter-spacing: -0.05em; }
    </style>
</head>
<body class="bg-white text-[#1A1A1A]">
    <nav class="sticky top-0 bg-white/80 backdrop-blur-md z-50 p-8 border-b-2 border-black flex justify-between items-center">
        <span class="text-3xl font-black uppercase tracking-tighter">Axis</span>
        <div class="hidden md:flex gap-8 text-xs font-bold uppercase">
            <a href="#" class="hover:text-[#FF0000]">Projects</a>
            <a href="#" class="hover:text-[#FF0000]">Studio</a>
            <a href="#" class="hover:text-[#FF0000]">Contact</a>
        </div>
        <button class="bg-[#FF0000] text-white px-6 py-2 text-xs font-bold uppercase rounded-none">Hire Us</button>
    </nav>
    
    <main>
        <section class="min-h-screen flex items-center justify-center p-8">
            <div class="max-w-7xl w-full">
                <h1 class="hero-title text-[15vw] font-black uppercase mb-8">Designing<br/>Silence</h1>
                <p class="max-w-xl text-lg font-light leading-relaxed">
                    We believe architecture is the art of organizing light and shadow. Precision in every line.
                </p>
            </div>
        </section>
        
        <section class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="aspect-square bg-zinc-100 border-2 border-black flex items-center justify-center">
                <span class="text-xs font-mono">[Featured Project 01]</span>
            </div>
            <div class="aspect-square bg-zinc-100 border-2 border-black flex items-center justify-center mt-20">
                <span class="text-xs font-mono">[Featured Project 02]</span>
            </div>
        </section>
    </main>

    <footer class="p-8 border-t-2 border-black mt-20 flex justify-between items-end">
        <div class="text-xs font-bold uppercase">Axis Architecture © 2026</div>
        <div class="flex gap-4">
            <i data-lucide="instagram" class="w-4 h-4"></i>
            <i data-lucide="twitter" class="w-4 h-4"></i>
        </div>
    </footer>

    <script>
        lucide.createIcons();
    </script>
</body>
</html>
```
### 节点 D: 处理问题并识别 (Editor)
- **职责**: 根据用户反馈和当前文件列表，识别需要读取的文件。
- **输入**: User Feedback + File List + Error Logs.
- **输出**: 工具调用 `read_file(path)`。

#### 示例：节点 D 上下文与输出

**输入上下文**:
- **System Prompt**: "You are a Maintenance Engineer. Analyze the user's feedback and decide which files need to be inspected to perform the modification."
- **User Instruction**: "The 'Hire Us' button should be rounded and blue instead of sharp and red."
- **Current File List**: `["/index.html"]`
- **Error Logs**: `[]`
- **Protocol**: "Use `=== read: path ===` to request file content."

**上下文组装**:

```typescript
const templateD = `
You are a Maintenance Engineer. A user wants to modify an existing website. Your task is to identify which files must be read to implement these changes.

### 1. USER INSTRUCTION
${user_instruction}

### 2. CURRENT PROJECT FILES
${vfs_file_list}

### 3. REPORTED ERRORS
${error_logs || "None"}

### 4. INSTRUCTIONS
- Identify which file(s) contain the code that needs modification.
- In most cases for this project, it will be "/index.html".
- Use the VFS protocol to read the file.

### PROTOCOL (CRITICAL)
=== read: [file_path] ===
`;
```

**节点 D 输出 (Decision)**:

```text
The user wants to change the styling of the 'Hire Us' button. Since this is a single-page site, the relevant code is in the main HTML file.

=== read: /index.html ===
```

### 节点 E：解决问题 (Resolver/Writer)
- **职责**: 应用修改并将完整的更新文件写回 VFS。
- **输入**: User Instruction + File Content (from Node D) + Tech Stack Rules.
- **输出**: 工具调用 `write_file(path, content)`。

#### 示例：节点 E 上下文与输出

**输入上下文**:
- **System Prompt**: "You are a Senior Developer. Update the provided file content based on the user's instructions while maintaining technical standards."
- **User Instruction**: "The 'Hire Us' button should be rounded and blue instead of sharp and red."
- **Current Content (from Node D)**: (包含 `<button class="bg-[#FF0000] ... rounded-none">Hire Us</button>` 的 HTML)
- **Tech Stack Rules**: (Tailwind CDN constraints)
- **Protocol**: "Use `=== write: path ===` followed by the FULL content."

**上下文组装**:

```typescript
const templateE = `
You are a Senior Frontend Developer. You have been provided with the content of a file and a specific modification request from the user.

### 1. USER INSTRUCTION
${user_instruction}

### 2. CURRENT FILE CONTENT
=== content: ${target_file_path} ===
${target_file_content}

### 3. TECHNICAL RULES
- Tech Stack: ${selected_tech_stack.description_style}
- Preserve all existing CDN links and script initializations.
- Do NOT output partial diffs. Output the ENTIRE file content.

### 4. INSTRUCTIONS
- Analyze the code and apply the requested changes accurately.
- Use Tailwind classes for styling modifications.
- Ensure the resulting page is still valid and functional.

### PROTOCOL (CRITICAL)
=== write: [file_path] ===
[Full content here]
`;
```

**节点 E 输出 (Final Edit)**:

```text
I have updated the 'Hire Us' button to be blue (`bg-blue-600`) and fully rounded (`rounded-full`).

=== write: /index.html ===
<!DOCTYPE html>
<html lang="en">
...
    <nav class="sticky top-0 bg-white/80 backdrop-blur-md z-50 p-8 border-b-2 border-black flex justify-between items-center">
        <span class="text-3xl font-black uppercase tracking-tighter">Axis</span>
        ...
        <button class="bg-blue-600 text-white px-6 py-2 text-xs font-bold uppercase rounded-full">Hire Us</button>
    </nav>
...
</html>
```

---

## 4. Graph 路由逻辑 (Router)

我们需要一个简单的路由逻辑来决定使用哪个 Graph：

- **Initial Gen**: 如果 `vfs.list_directory("/")` 为空，或用户显式发送 `/reset`, `/new` 等指令。
- **Refinement**: 如果 `index.html` 存在，且用户输入非重置指令。

*(注：在 LangGraph 中，可以通过检查 State 中的 `is_initialized` 标记来实现)*

## 5. 技术栈样本库 (Boilerplate Library)

我们将预定义以下几种技术栈的样本，存储在 `lib/boilerplates/` 中：

1.  **HTML + Tailwind (Default)**: 最轻量，适合静态展示。
2.  **React (CDN) + Tailwind**: 适合需要交互的组件。
    - *关键点*: 使用 Babel Standalone 编译 JSX。
    - *示例*:
      ```html
      <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
      <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
      <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
      <script type="text/babel">
        // React Code Here
      </script>
      ```

## 6. 下一步行动

1.  **创建 Boilerplate 模块**: 实现 `lib/boilerplates/index.ts`。
2.  **实现 Initial Gen Graph**:
    - 定义 `State` (包含 requirement, style_spec)。
    - 实现 3 个节点的逻辑。
3.  **实现 Refinement Graph**:
    - 定义单节点 Loop。
4.  **UI 集成**: 在 `WebTab` 中根据 VFS 状态自动路由。
