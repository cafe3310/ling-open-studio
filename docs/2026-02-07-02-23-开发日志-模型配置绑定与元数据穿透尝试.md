# 2026-02-07-02-23-开发日志-模型配置绑定与元数据穿透尝试

## 背景

在完成多 Tab 架构和基础 Chat 集成后，本次开发的目标是将右侧 "Model Config" 面板的参数（模型选择、系统提示词、温度）与后端推理逻辑打通，并尝试在消息顶部显示生成状态。

## 来源文档

- [docs/2026-02-07-01-32-设计-模型参数绑定与消息状态行.md](./2026-02-07-01-32-设计-模型参数绑定与消息状态行.md)
- [docs/TODO.md](./TODO.md)

## 完成的功能点

### 1. 模型参数状态管理 (Zustand Store)
- 创建了 `lib/store.ts` 用于存储全局模型配置。
- 支持 `modelId` (默认 Ling_1T), `systemPrompt`, `temperature` (默认 0.6)。

### 2. UI 绑定与交互限制
- **ModelConfig 组件**: 
    - 绑定了 Store 中的数据。
    - 引入了 `useThread` 监听消息列表。一旦 `messages.length > 0`（对话已开始），“模型选择”和“系统提示词”变为禁用状态。
    - 增加了 Tooltip 提示，向用户解释为什么在对话中无法修改这些核心参数。
- **Assistant 组件**:
    - 在 `AssistantChatTransport` 的 `body` 字段中注入了实时的 `config` 对象。

### 3. 后端动态模型选择
- **API 路由**: `/api/chat/route.ts` 现在会从请求体中提取 `config`，并通过 `configurable.modelConfig` 传递给 LangGraph。
- **LangGraph 节点**: `app/lib/assistants/simple-graph.ts` 中的 `callModel` 节点现已重构：
    - 动态从 `config` 中读取参数。
    - 使用工厂函数 `createChatModel` 根据用户选择实例化模型。
    - 如果配置了 `systemPrompt`，会自动在消息流首部注入 `SystemMessage`。

## 遇到的问题与未完成项

### 消息状态行 (Message Status Line) 元数据丢失
- **尝试方案**: 在后端计算 `latency` 并获取 `model_name`，放入 `AIMessageChunk` 的元数据中，试图在前端 UI 展示。
- **阻碍**: 
    - 经过调试发现，`@ai-sdk/langchain` 提供的 `toUIMessageStream` 在将 LangChain 消息流转换为 AI SDK 格式时，并没有完整保留自定义元数据字段。
    - 虽然在后端原始流中可以看到这些字段，但前端 `useThread` 获取的消息对象中 `metadata` 始终为空。
    - 尝试了多种解构和拦截流的方式，均未能实现稳定的“元数据穿透”。
- **结论**: 暂时回退了 UI 上的状态行代码，以保证系统的稳定性。后续可能需要通过 AI SDK 的 `StreamData` 协议手动发送额外的非消息数据块来实现此功能。

## 后续建议

1. **元数据展示**: 若必须显示 `latency`，建议放弃依赖消息内置 metadata，改为使用 `createDataStreamResponse` 发送自定义数据块。
2. **Tab 内容填充**: 接下来可以开始 `Model Web` 或 `Model Write` 标签页的内容开发。
