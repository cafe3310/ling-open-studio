# 2026-02-07-11-11-系统设计-浏览器端虚拟文件系统(VFS)

## 1. 概述 (Overview)

为了支持 "Model Web" (网页生成与预览)、"Model Write" (写作协作) 以及未来的 AI Tool Calls (如读写本地文件)，系统将在浏览器端实现一个持久化的虚拟文件系统 (Virtual File System, VFS)。

VFS 是一个专为 AI 协作设计的浏览器端持久化文件系统。它作为 "Model Web"、"Model Write" 和 AI Tool Calls 的底层基础设施，提供类 POSIX 的操作接口，并具备线程隔离和权限保护。

## 2. 核心架构 (Architecture)

### 2.1 存储层 (Storage Layer)
- **底层引擎**: IndexedDB (Database: `ling-vfs-db`)。
- **数据库名**: `ling-vfs-db`
- **版本**: `1`
- **核心 Store**: `files`
    - **Key**: `id` (UUID)。
    - **Indices**: 
        - `threadId`: (non-unique) 隔离不同会话的文件。
        - `[threadId, path]`: (unique) 唯一索引，确保同一会话下路径唯一。
        - `type`: (non-unique) 用于快速筛选文件类型。

### 2.2 逻辑层 (Logic Layer)
- **扁平化设计**: 采用类似对象存储（S3）的设计，不维护独立的目录树对象。目录通过文件路径的前缀（如 `/workspace/src/`）隐式存在。
- **线程隔离**: 所有 API 操作均需传入 `threadId`，确保不同 Chat 线程的文件互不干扰。
- **性能**: 使用 `IDBKeyRange` 进行范围查询，实现秒级目录列表。

## 3. 分区与权限 (Partitions & Permissions)

系统通过**路径前缀**将文件系统划分为不同的区域，并根据操作来源 (`source`: 'user' | 'agent') 实施权限控制。

| 挂载点 | 路径前缀 | AI 权限 (Agent) | 用户权限 (User) | 用途与场景 |
| :--- | :--- | :--- | :--- | :--- |
| **工作区 (Workspace)** | `/workspace/` | **R/W** (读写) | **R/W** (读写) | 存放生成的代码 (`App.tsx`)、小说章节 (`chapter1.md`)、中间产物。 |
| **系统资源 (System)** | `/system/` | **R** (只读) | **R/W** (读写) | 存放 Skill 定义 (`skills.json`)、UI 模版 (`template.hbs`)、世界观设定。 |

**权限规则**:
1.  **User (UI)** 拥有所有区域的读写权限（上帝模式）。
2.  **Agent (AI)** 仅能写入 `/workspace/` 开头的路径。试图写入 `/system/` 将抛出 `PermissionError`。
3.  **Agent (AI)** 可以读取 `/system/` 下的内容作为上下文参考。

## 4. 数据结构 (Data Model)

### 4.1 文件类型 (`FileType`)
```typescript
export type FileType = 
  | 'text'      // md, txt, xml
  | 'code'      // js, ts, py, html, css
  | 'json'      // json
  | 'image'     // png, jpg, svg (base64)
  | 'binary';   // other
```

### 4.2 虚拟文件对象 (`VirtualFile`)
```typescript
export interface VirtualFile {
  id: string;           // UUID
  threadId: string;     // 所属线程 ID
  path: string;         // 完整路径，必须以 /workspace/ 或 /system/ 开头
  name: string;         // 文件名 (path.split('/').pop())
  
  content: string | ArrayBuffer; // 内容
  
  type: FileType;       // 抽象类型
  mimeType: string;     // 具体 MIME (e.g., "application/javascript")
  size: number;         // 字节数
  
  createdAt: number;    // 时间戳
  updatedAt: number;    // 时间戳
  
  metadata: {
    lastModifiedBy: 'agent' | 'user'; // 标记最后修改者
    isTransient?: boolean;           // 是否为不落库的内存文件
    [key: string]: any;              // 扩展元数据
  };
  
  isReadOnly?: boolean; // 辅助标记，用于 UI 展示锁图标
}
```

## 5. API 接口设计 (Interface Design)

### 5.1 基础操作 (`IVirtualFileSystem`)

```typescript
interface IVirtualFileSystem {
  init(): Promise<void>;

  /**
   * 写入文件
   * @param source 'agent' | 'user' - 默认为 'agent'
   * @throws PermissionError 如果 agent 尝试写入受保护区域
   */
  writeFile(threadId: string, path: string, content: string | ArrayBuffer, source?: 'agent' | 'user'): Promise<VirtualFile>;

  readFile(threadId: string, path: string): Promise<VirtualFile>;

  exists(threadId: string, path: string): Promise<boolean>;

  deleteFile(threadId: string, path: string, source?: 'agent' | 'user'): Promise<void>;

  renameFile(threadId: string, oldPath: string, newPath: string, source?: 'agent' | 'user'): Promise<VirtualFile>;
  
  stat(threadId: string, path: string): Promise<Omit<VirtualFile, 'content'>>;
}
```

### 5.2 目录与查询

```typescript
interface IVirtualFileSystem {
  /**
   * 列出指定前缀下的文件
   * @param dirPath 例如 "/workspace/src/"
   * 使用 IDBKeyRange 扫描，比全量遍历更高效
   */
  listDir(threadId: string, dirPath?: string): Promise<VirtualFile[]>;

  /**
   * 递归清空目录
   */
  deleteDir(threadId: string, dirPath: string, source?: 'agent' | 'user'): Promise<void>;
  
  /**
   * 清空整个线程的工作区
   */
  clearThread(threadId: string): Promise<void>;
}
```

### 5.3 响应式支持

```typescript
interface IVirtualFileSystem {
  /**
   * 监听该线程下任何文件的变更
   * 用于 UI 热更新 (预览窗口)
   */
  subscribe(threadId: string, callback: () => void): () => void;
}
```

## 6. 应用场景映射 (Scenarios)

### 6.1 网页生成 (Model Web)
1.  **初始化**: 系统启动时将预置的 React 模版写入 `/system/templates/react/` (User 权限)。
2.  **生成**: AI 收到指令，读取模版，在 `/workspace/preview/` 下生成 `App.tsx` 和 `index.html` (Agent 权限)。
3.  **预览**: Preview 组件通过 `subscribe` 监听 `/workspace/preview/`，通过 iframe 渲染最新内容。

### 6.2 小说创作 (Model Write)
1.  **设定**: 用户上传 `人物小传.md` 到 `/system/novel/characters.md` (User 权限)。
2.  **写作**: AI 读取设定，在 `/workspace/novel/chapter-1.md` 续写章节 (Agent 权限)。
3.  **校对**: 用户在编辑器中直接修改 `/workspace/novel/chapter-1.md` (User 权限)，系统记录 `lastModifiedBy: 'user'`。

## 7. 开发计划 (Roadmap)

1.  **Phase 1: 核心库实现**
    - 实现 `lib/vfs/db.ts` (IndexedDB Adapter)。
    - 实现 `lib/vfs/core.ts` (核心逻辑、权限控制、路径规范化)。
    - 实现 `lib/vfs/utils.ts` (MimeType 解析、路径工具)。
    - 单元测试/控制台手动验证。

2.  **Phase 2: React 集成**
    - 实现 `useVFS` Hook。
    - 实现 `FileExplorer` UI 组件 (只读/简单管理)。

3.  **Phase 3: 业务集成**
    - 接入 "Model Web" Tab 实现代码预览。
    - 接入 "Model Write" Tab 实现 Markdown 编辑器同步。
