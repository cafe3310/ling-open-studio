# 2026-02-07-02-29-开发日志-集成思考过程(Reasoning)渲染支持

## 背景

用户希望模型输出的 `<think>` 标签内容能够被识别为“思考过程”，并使用 `assistant-ui` 提供的原生 `Reasoning` 组件进行渲染，以提升产品的专业感和交互体验。

## 来源文档

- 用户的直接需求：将 `<think>` 部分标记为思考。
- 参考项目：`ling-model-judge` (关于 Message Parts 的渲染调研)。

## 实现方案

### 1. 核心转换逻辑 (`ReasoningSplitter`)
由于模型通常将思考过程嵌入在普通文本中（如 DeepSeek-R1），我们需要在后端进行流式解析。
- 创建了 `app/lib/assistants/reasoning-splitter.ts`。
- 实现了一个状态机，能够处理流式数据中的 `<think>` 和 `</think>` 标签。
- 特别处理了“标签跨块”的情况（例如一个 Chunk 结尾是 `<th`，下一个 Chunk 开头是 `ink>`）。
- 将解析出的内容包装成 LangChain 的 `contentBlocks` (kwargs) 和 `content` (array) 格式。

### 2. 后端集成
- 在 `app/api/chat/route.ts` 中引入 `ReasoningSplitter`。
- 在 `toUIMessageStream` 处理流之前，先通过 `splitter.transform()` 对 LangGraph 的原始流进行转换。
- 这样，原本属于文本的消息分块会被拆分为 `type: "reasoning"` 和 `type: "text"` 的多个分块。

### 3. 前端展示
- `assistant-ui` 的 `MessagePrimitive.Parts` 组件能够识别 `type: "reasoning"` 的分块。
- 结合项目中已有的 `components/assistant-ui/reasoning.tsx`，前端会自动渲染出带有“大脑”图标、支持折叠、且在思考时有 Shimmer 动画效果的 UI。

## 后续建议

- **模型兼容性**: 目前主要针对显式输出 `<think>` 标签的模型。如果未来使用通过 API 字段返回 reasoning 的模型，可以进一步优化 `ReasoningSplitter` 以兼顾多种模式。
- **UI 微调**: 可以根据品牌风格进一步微调 `Reasoning` 组件的背景色和字体样式。
