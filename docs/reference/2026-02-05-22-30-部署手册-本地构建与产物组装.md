# 部署手册：本地构建与产物组装 (Standalone 模式)

## 1. 背景
为了确保项目能够成功部署到 Hugging Face Spaces，我们需要掌握如何手动构建并在本地验证生产环境产物。本文档详细记录了从源码到可执行部署包的转换过程。

## 2. 操作步骤

### 第一步：准备静态资源目录
Next.js 推荐将静态资源（如图片、图标）放在根目录下的 `public` 文件夹中。

```bash
mkdir -p public
# 如果 app/favicon.ico 存在，把它复制到 public/
cp app/favicon.ico public/ 2>/dev/null || echo "favicon.ico not found in app/"
```

### 第二步：配置环境与构建
1. **修改依赖管理模式**:
   为了避免 Docker 中符号链接失效，配置 pnpm 使用 hoisted 模式：
   ```bash
   # 在项目根目录执行
   echo "node-linker=hoisted" >> .npmrc
   rm -rf node_modules
   pnpm install
   ```

2. **执行构建**:
   执行 Standalone 模式构建。确保 `next.config.ts` 中已设置 `output: 'standalone'`。
   ```bash
   pnpm build
   ```

### 第三步：组装部署包
由于 `standalone` 目录不包含静态资源，我们需要手动将它们组装到一个部署目录中。我们将使用 `./tmp/deploy` 目录（请确保 `tmp/` 在 `.gitignore` 中）。

1. **创建部署目录**:
   ```bash
   rm -rf tmp/deploy && mkdir -p tmp/deploy
   ```

2. **复制 Dockerfile**:
   ```bash
   # 务必确保 Dockerfile.hf 内容是最新的
   cp Dockerfile.hf tmp/deploy/Dockerfile
   ```

3. **复制静态资源 (public)**:
   ```bash
   cp -r public tmp/deploy/public
   ```

4. **复制构建产物 (.next/static)**:
   ```bash
   mkdir -p tmp/deploy/.next
   cp -r .next/static tmp/deploy/.next/static
   ```

5. **复制 Standalone 服务器**:
   将 `.next/standalone` 下的内容（包含 `server.js` 和精简版的 `node_modules`）复制到部署目录根路径。
   ```bash
   # 现在 node_modules 已被平铺 (hoisted)，可以直接递归复制
   cp -R .next/standalone/ tmp/deploy/
   ```

### 第四步：本地 Docker 验证
在将产物推送到 Hugging Face 之前，应在本地模拟其运行环境。

1. **构建镜像**:
   ```bash
   cd tmp/deploy
   docker build -t ling-open-studio-test .
   ```

2. **运行容器**:
   ```bash
   docker run -p 7860:7860 ling-open-studio-test
   ```

3. **测试访问**:
   打开浏览器访问 `http://localhost:7860`。

## 3. 注意事项
- **端口**: Hugging Face 默认使用 `7860` 端口。
- **符号链接**: 务必在 `.npmrc` 中开启 `node-linker=hoisted`，否则在复制或 Docker 构建时可能因符号链接失效导致文件缺失。
- **显式复制**: `Dockerfile.hf` 采用显式复制策略 (`public`, `.next`, `node_modules`, `server.js`, `package.json`)，确保容器内文件结构清晰。