# 部署手册：本地构建与产物组装 (Standalone 模式)

## 1. 背景
为了确保项目能够成功部署到 Hugging Face Spaces，我们需要掌握如何手动构建并在本地验证生产环境产物。本文档详细记录了从源码到可执行部署包的转换过程。

## 2. 操作步骤

### 第一步：准备静态资源目录
Next.js 推荐将静态资源（如图片、图标）放在根目录下的 `public` 文件夹中。

```bash
mkdir -p public
# 如果 app/favicon.ico 存在，把它复制到 public/
cp app/favicon.ico public/ 2>/dev/null || echo "favicon.ico not found in app/"
```

### 第二步：配置环境与构建
1. **修改依赖管理模式**:
   为了避免 Docker 中符号链接失效，配置 pnpm 使用 hoisted 模式：
   ```bash
   # 在项目根目录执行
   echo "node-linker=hoisted" >> .npmrc
   rm -rf node_modules
   pnpm install
   ```

2. **执行构建**:
   执行 Standalone 模式构建。确保 `next.config.ts` 中已设置 `output: 'standalone'`。
   ```bash
   pnpm build
   ```

### 第三步：组装部署包
由于 `standalone` 目录不包含静态资源，我们需要手动将它们组装到一个部署目录中。我们将使用 `./tmp/deploy` 目录（请确保 `tmp/` 在 `.gitignore` 中）。

1. **创建部署目录**:
   ```bash
   rm -rf tmp/deploy && mkdir -p tmp/deploy
   ```

2. **复制 Dockerfile 与 HF 元数据**:
   ```bash
   # 务必确保 Dockerfile.hf 和 README.hf.md 内容是最新的
   cp Dockerfile.hf tmp/deploy/Dockerfile
   cp README.hf.md tmp/deploy/README.md
   ```
   *(注意：README.md 是 Hugging Face 识别 Docker Space 的关键文件)*

3. **复制静态资源 (public)**:
   ```bash
   cp -r public tmp/deploy/public
   ```

4. **复制构建产物 (.next/static)**:
   ```bash
   mkdir -p tmp/deploy/.next
   cp -r .next/static tmp/deploy/.next/static
   ```

5. **复制 Standalone 服务器**:
   将 `.next/standalone` 下的内容（包含 `server.js`、`.next` 配置和精简版的 `node_modules`）复制到部署目录根路径。
   
   **注意**：必须使用 `.` 来确保隐藏的 `.next` 目录也被复制。
   ```bash
   # 确保复制所有内容，包括隐藏文件
   cp -R .next/standalone/. tmp/deploy/
   ```

6. **清理重型依赖 (关键)**:
   Hugging Face 对单个文件有 10MB 限制。由于我们已在 `next.config.ts` 中禁用了图片优化，可以安全删除 `sharp` 及其二进制库。
   ```bash
   cd tmp/deploy
   # 移除图片优化相关
   rm -rf node_modules/sharp
   rm -rf node_modules/@img
   # 移除开发工具
   rm -rf node_modules/typescript
   rm -rf node_modules/@types
   rm -rf node_modules/@biomejs
   rm -rf node_modules/eslint
   rm -rf node_modules/prettier
   # 移除源码映射
   find . -name "*.map" -type f -delete
   ```

### 第四步：本地 Docker 验证
在将产物推送到 Hugging Face 之前，应在本地模拟其运行环境。**由于项目依赖多个 API 密钥和后端 URL，必须正确透传环境变量。**

1. **准备环境变量文件**:
   在本地构建完成后，建议创建一个专门用于 Docker 测试的环境变量文件 `tmp/deploy/.env.docker`：
   ```env
   # 基础 API 配置
   OPENAI_API_KEY=sk-...
   OPENAI_API_BASE=https://api.example.com/v1
   
   # 模型 ID 映射 (可选，如果不设置则使用默认值)
   MODEL_ID_LING_1T=ling-1t
   MODEL_ID_RING_1T=ring-1t
   MODEL_ID_LING_FLASH=ling-flash
   MODEL_ID_RING_FLASH=ring-flash
   MODEL_ID_LING_MINI=ling-mini
   MODEL_ID_RING_MINI=ring-mini
   ```

2. **构建镜像**:
   ```bash
   cd tmp/deploy
   docker build -t ling-open-studio-test .
   ```

3. **带环境变量运行容器**:
   使用 `--env-file` 参数将配置注入容器：
   ```bash
   docker run -p 7860:7860 --env-file .env.docker ling-open-studio-test
   ```
   *或者使用 `-e` 单独指定：*
   `docker run -p 7860:7860 -e OPENAI_API_KEY=sk-... ling-open-studio-test`

4. **测试访问**:
   打开浏览器访问 `http://localhost:7860`。

## 3. 注意事项
- **端口**: Hugging Face 默认使用 `7860` 端口。
- **隐藏文件**: 复制 standalone 时务必检查 `deploy_package/.next` 是否存在且包含 `BUILD_ID` 等文件，否则服务器无法启动。
- **显式复制**: `Dockerfile.hf` 采用显式复制策略 (`public`, `.next`, `node_modules`, `server.js`, `package.json`)，确保容器内文件结构清晰。
