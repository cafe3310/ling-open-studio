# 开发日志：Hugging Face 部署流水线实现

## 1. 概览
本次开发的主要目标是建立从 GitHub 到 Hugging Face Spaces 的自动化部署流水线。我们采用了 Docker Standalone 模式，通过 GitHub Actions 构建并推送精简后的产物。

**完成的主要任务：**
- [x] 配置 Next.js 的 `output: 'standalone'` 模式。
- [x] 编写适配 Hugging Face 环境的 `Dockerfile.hf`。
- [x] 设计并验证本地产物组装流程。
- [x] 创建 GitHub Actions 工作流 (`deploy-hf.yml`)。
- [x] 解决文件体积过大和跨平台依赖问题。

## 2. 遇到的问题与解决方案

### 2.1 pnpm 符号链接兼容性问题
**问题描述**：默认情况下，pnpm 使用符号链接管理依赖。在执行 `cp` 命令或在 Docker 构建过程中，这些符号链接经常导致文件丢失或路径无法解析。
**解决方案**：
- 启用 **Hoisted 模式**。在 `.npmrc` 中添加 `node-linker=hoisted`，强制 pnpm 平铺安装依赖，模拟 npm/yarn 的行为。
- 这确保了 `standalone` 目录中的 `node_modules` 是物理文件，而非链接。

### 2.2 Dockerfile `COPY` 路径错误
**问题描述**：最初的 Dockerfile 试图执行 `COPY standalone/ ./`，但构建上下文本身就是 `standalone` 的内容平铺后的结果，导致找不到目录。
**解决方案**：
- 采用 **显式复制策略**。在 Dockerfile 中明确列出 `COPY public ...`, `COPY .next ...`, `COPY server.js ...` 等。
- 最终简化为 `COPY . .`（在确保部署包目录纯净的前提下），但在最终版本中为了清晰，我们还是保留了显式复制关键目录的做法，或者利用 `deploy_package` 的纯净性直接复制。

### 2.3 `standalone` 缺失 `.next` 隐藏目录
**问题描述**：使用 `cp -R .next/standalone/* tmp/deploy/` 时，Shell 的通配符 `*` 忽略了以 `.` 开头的隐藏目录（如 `.next`）。导致 Docker 容器启动时报错 `Could not find a production build`。
**解决方案**：
- 修改复制命令为 `cp -R .next/standalone/. deploy_package/`。使用 `.` 指代当前目录所有内容（包含隐藏文件）。

### 2.4 Hugging Face 10MB 文件限制
**问题描述**：推送时报错 `remote: Your push was rejected because it contains files larger than 10 MiB`。分析发现是 `sharp` 库的 macOS 二进制文件 (`libvips-cpp.dylib`) 超标。
**解决方案**：
- **禁用图片优化**：在 `next.config.ts` 中设置 `images: { unoptimized: true }`。
- **激进清理**：在 GitHub Actions 中增加清理步骤，彻底删除 `node_modules/sharp`、`node_modules/@img` 以及所有非 Linux 平台的二进制包 (`darwin`, `win32`)。

### 2.5 Hugging Face 元数据缺失
**问题描述**：部署成功但 Space 无法启动，或者无法识别为 Docker 应用。
**解决方案**：
- 创建 `README.hf.md`，包含 `sdk: docker` 和 `app_port: 7860` 等 YAML frontmatter。
- 在部署脚本中将其复制为 `README.md`。

## 3. 关键配置快照

### `next.config.ts` (优化版)
```typescript
const nextConfig: NextConfig = {
  output: 'standalone',
  compress: true,
  images: {
    unoptimized: true, // 关键：移除 sharp 依赖
  },
  outputFileTracingExcludes: {
    '*': [
      'node_modules/@swc/core-linux-x64-gnu',
      // ... 其他排除项
    ],
  },
};
```

### `deploy-hf.yml` (核心逻辑)
```yaml
- name: Prepare Deployment Artifacts
  run: |
    # 1. 复制 Standalone (包含隐藏文件)
    cp -R .next/standalone/. deploy_package/
    
    # 2. 清理重型依赖
    rm -rf deploy_package/node_modules/sharp
    rm -rf deploy_package/node_modules/@img
    # ... 移除 typescript, eslint 等
    
    # 3. 添加 HF 元数据
    cp README.hf.md deploy_package/README.md
```

## 4. 后续规划
当前流水线已稳定运行。接下来的工作重点将转向功能开发：
- 实现 Model Chat 基础界面。
- 集成 LangGraph 后端。
