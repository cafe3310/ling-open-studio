# 设计：Hugging Face 自动化部署流水线

## 1. 背景与目标
为了实现 `ling-open-studio` (InclusionAI Demo) 的持续交付，我们需要建立一套自动化的部署流水线。
参考 `osw-studio-hf` 的实践，我们将采用 **"CI 构建 -> 产物推送 -> HF 运行"** 的模式。这种模式避免了在 Hugging Face 弱算力环境下进行耗时的构建过程，同时利用 GitHub Actions 的环境一致性。

## 2. 核心调整

### 2.1 Next.js 配置 (Standalone Mode)
Next.js 的 `output: 'standalone'` 模式会自动追踪依赖，仅打包生产环境所需的最小文件集（包括 `node_modules`）。

**修改 `next.config.ts`**:
```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  output: 'standalone',
  // 确保 sharp 等依赖被正确处理（如果需要）
  experimental: {
    // serverActions: true, // Next.js 15+ 默认开启
  },
};

export default nextConfig;
```

### 2.2 构建产物结构
执行 `pnpm build` 后，Next.js 会生成 `.next/standalone` 目录。
为了在 Docker 中运行，我们需要组装以下文件结构到部署目录（例如 `deploy/`）：

```text
deploy/
├── Dockerfile          # 专门用于运行的 Dockerfile
├── public/             # 静态资源 (from project root)
├── .next/
│   └── static/         # 静态资源 (from .next/static)
├── server.js           # (from .next/standalone/server.js)
├── package.json        # (from .next/standalone/package.json)
└── .next/              # (from .next/standalone/.next - 包含 server 构建)
```

**注意**：`.next/standalone` 下已经包含了必要的 `node_modules` 和 `server.js`。但它**不包含** `public` 文件夹和 `.next/static` 文件夹（因为这些通常由 CDN 处理）。在 Docker 部署中，我们需要手动复制这些文件夹。

### 2.3 Dockerfile 设计
这个 Dockerfile 将被推送到 Hugging Face Space。它不做构建，只做运行。

```dockerfile
# 基础镜像
FROM node:20-alpine

# 设置环境变量
ENV NODE_ENV=production \
    PORT=7860 \
    HOSTNAME="0.0.0.0"

# 创建非 root 用户 (Hugging Face 推荐)
RUN addgroup -S appgroup && adduser -S appuser -G appgroup

WORKDIR /app

# 复制构建产物 (由 CI 准备好)
COPY --chown=appuser:appgroup public ./public
COPY --chown=appuser:appgroup .next/static ./.next/static
# 复制 standalone 目录的内容到 /app
COPY --chown=appuser:appgroup standalone/ ./

# 切换用户
USER appuser

# 暴露端口
EXPOSE 7860

# 启动命令
CMD ["node", "server.js"]
```

## 3. GitHub Actions 流水线设计

我们需要创建一个 Workflow (`.github/workflows/deploy-hf.yml`)。

**前置条件**:
1.  在 Hugging Face 创建一个 Docker Space (e.g., `ling-open-studio`).
2.  获取 Hugging Face Access Token (Write 权限)。
3.  在 GitHub 仓库设置 Secrets: `HF_TOKEN`, `HF_SPACE_NAME` (e.g., `username/space-name`).

**Workflow 步骤**:
1.  **Checkout**: 拉取代码。
2.  **Install & Build**:
    ```bash
    npm install -g pnpm
    pnpm install
    pnpm build
    ```
3.  **Prepare Deployment Artifacts**:
    创建 `deploy_package` 目录，将必要文件移入：
    ```bash
    mkdir deploy_package
    cp Dockerfile.hf deploy_package/Dockerfile
    cp -r public deploy_package/public
    mkdir -p deploy_package/.next
    cp -r .next/static deploy_package/.next/static
    cp -r .next/standalone/* deploy_package/
    ```
4.  **Push to Hugging Face**:
    使用 `main` 分支的内容强制推送到 HF Space 的 Git 仓库。
    *注意：这里我们通过 git push 操作，将 `deploy_package` 的内容覆盖推送到 HF Space。*

## 4. 行动计划 (Action Items)

1.  **本地配置**:
    - [ ] 修改 `next.config.ts` 开启 standalone。
    - [ ] 创建 `Dockerfile.hf` (用于部署)。
    - [ ] 本地模拟构建：运行 `pnpm build` 并手动验证 standalone 目录结构。

2.  **验证 Docker**:
    - [ ] 在本地使用 `Dockerfile.hf` 构建镜像并运行，确保 `localhost:7860` 能访问。

3.  **CI 配置**:
    - [ ] 创建 `.github/workflows/deploy.yml`。
    - [ ] (用户操作) 设置 GitHub Secrets。

4.  **文档更新**:
    - [ ] 更新 `README.md` 添加部署状态徽章和说明。
