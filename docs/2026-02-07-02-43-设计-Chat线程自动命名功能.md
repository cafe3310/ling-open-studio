# 2026-02-07-02-43-设计-Chat线程自动命名功能

## 1. 背景与目标
为了提升用户管理历史会话的体验，系统需要在用户与模型完成第一轮对话后，自动根据对话内容生成一个简短、概括性的标题，替换默认的 "New Chat"。

## 2. 核心需求
1.  **触发时机**：用户与模型完成一轮对话（即 `messages` 列表包含一条 User 消息和一条 Assistant 消息）后触发。
2.  **模型指定**：固定使用 `Ling-Mini` 模型，以保证响应速度和低成本。
3.  **独立架构**：使用一个独立的 LangGraph 图 `chat_name_generator` 来处理命名逻辑。
4.  **UI 交互**：
    - 在生成过程中，侧边栏或标题栏的 Thread 名称显示为 "Naming..."。
    - 生成完成后，更新为真实的标题。

## 3. 技术方案设计

### 3.1 后端架构

#### A. 新增 Graph: `chat_name_generator`
- **位置**: `app/lib/assistants/naming-graph.ts`
- **结构**:
    - **State**: `{ messages: BaseMessage[], generated_title: string }`
    - **Node**: `generateTitle`
        - 输入：对话历史（通常取前两三条）。
        - 逻辑：调用 `Ling-Mini` 模型，使用专门的 Prompt（如“请用 3-5 个字概括以上对话内容作为标题”）。
        - 输出：更新 `generated_title`。
- **Model**: 引用 `app/lib/model.ts` 中的 `Ling_Mini` 配置。

#### B. 新增 API Route
- **位置**: `app/api/naming/route.ts`
- **功能**:
    - 接收前端传入的 `messages` (或 `threadId`，视实现复杂度而定，传 messages 更无状态化)。
    - 运行 `chat_name_generator`。
    - 返回生成的标题字符串。

### 3.2 前端实现

#### A. 触发逻辑 (`NamingObserver`)
- **位置**: 新建组件 `components/naming-observer.tsx` (或者集成在 `ThreadListSidebar` / `Assistant` 中)。
- **逻辑**:
    - 监听 `useThread()` 的 `messages` 状态。
    - 当 `messages.length === 2` 且 `messages[1].role === 'assistant'` 且当前 Thread 标题未被手动修改过（或是默认值）时触发。
    - 触发时，先在本地状态或通过 `runtime` 将标题临时更新为 "Naming..."。
    - 调用 `/api/naming`。
    - 获取结果后，调用 `runtime.rename(threadId, newTitle)` (需确认 assistant-ui API) 或更新本地 Store。

#### B. 状态同步
- 需确保 `assistant-ui` 的 Thread 列表能即时反映标题的变化。

## 4. 详细 Prompt 设计 (Ling-Mini)
```text
Role: You are a helpful assistant specialized in summarizing conversations.
Task: Generate a concise title (3-6 words) for the following conversation.
Constraint: The title must be in the same language as the conversation. Do not use quotes.
Context:
{messages}
```

## 5. 开发步骤拆解
1.  **Graph 实现**: 编写 `naming-graph.ts` 并测试 `Ling-Mini` 调用。
2.  **API 实现**: 创建 `/api/naming` 接口。
3.  **UI 集成**: 编写前端监听逻辑，实现 "Naming..." 状态切换和 API 调用。
