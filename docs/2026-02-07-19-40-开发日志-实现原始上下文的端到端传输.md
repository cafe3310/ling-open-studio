# 2026-02-07-19-40-开发日志-实现原始上下文的端到端传输

## 1. 背景 (Background)
用户已确认服务端日志输出完整。现在的目标是将这些日志（TraceLog）实时传输到前端 Context Viewer。

## 2. 已完成工作 (Completed)
- **lib/model-tracer.ts**: 实现了 `tracedInvoke`。
    - 捕获输入和输出。
    - 服务端控制台美化打印。
    - 使用 `dispatchCustomEvent` 发射 `context_viewer_trace` 事件。

## 3. 即将实施的方案 (Plan)
### 3.1 API 路由改造 (app/api/chat/route.ts)
- **流模式变更**: 将 LangGraph 的 `streamMode` 从 `["messages"]` 扩展为 `["messages", "custom"]`。
- **流拦截**: 不再直接将整个流传给 `toUIMessageStream`，而是手动迭代。
- **自定义事件处理**: 
    - 当监听到 `kind === "custom"` 且事件名为 `context_viewer_trace` 时，使用 AI SDK 的 `writer.write` 方法将其作为 `data-context_viewer_trace` 类型的 Data Part 发送。
- **消息处理**: 继续保留 `ReasoningSplitter` 逻辑，确保思考过程和消息内容正确分发。

### 3.2 前端对接 (components/context-viewer/context-viewer-observer.tsx)
- 该组件已在之前的尝试中创建（并在回滚后被用户重新引入或由我再次创建），它将监听 `useThread` 中的 `parts`。
- 只要 API 路由正确发送了 `data-context_viewer_trace` 分块，观察者就能捕获并存入 Store。

## 4. 预期结果 (Expected Outcome)
- 用户发送消息。
- 服务端打印日志。
- 前端右上角 "Code" 图标对应的 Context Viewer 面板自动填充原始请求和响应 JSON。
