# 开发日志 - VFS 数据库自动初始化与 ModelWeb 多模型选择

## 背景 (Background)
用户反馈在 Chat Tab 中执行 VFS 相关工具调用（如 `write_file`）时，出现 "Database not initialized" 错误。此外，JS 评估工具在发生异常时未能正确将结果展示在 UI 右侧，且 Model-Web 模式需要支持分阶段切换不同的模型（设计 vs 代码生成）。

## 实现的功能点 (Key Changes)

### 1. VFS 数据库自动初始化
- **文件**: `apps/studio/src/lib/vfs/core.ts`
- **修改内容**:
    - 在 `VirtualFileSystem` 类中引入了 `initPromise` 和 `ensureInit` 私有方法。
    - 在所有文件操作方法（`writeFile`, `readFile`, `listDir` 等）开头调用 `await this.ensureInit()`。
- **效果**: 解决了因工具调用触发早于 VFS 初始化导致的数据库未就绪报错，提高了系统的鲁棒性。

### 2. 工具调用结果展示优化
- **文件**: `apps/studio/src/components/assistant-ui/tool-call-renderer.tsx`
- **修改内容**:
    - 引入了 `localResults` 状态，用于在工具执行成功后立即存储结果。
    - 将 `localResults` 与从线程历史解析出的 `executionInfo.results` 合并为 `mergedResults`。
- **效果**: 确保工具执行完成后，结果能即时显示在 [Tool Transaction] 的右侧列中，无需等待异步消息回填和状态同步。

### 3. JS 工具调用错误捕获与显示
- **文件**: `apps/studio/src/components/assistant-ui/tool-call-renderer.tsx`
- **修改内容**: 同上。
- **效果**: 即使 `browser_js_eval` 内部 eval 报错（如 `require is not defined`），错误字符串也会被正确回传并展示在右侧结果栏中，避免了 UI 状态丢失。

### 4. Model-Web 多模型配置切换
- **文件**: 
    - `apps/studio/src/lib/store.ts`: 新增 `designModelId` 和 `codeModelId` 状态。
    - `apps/studio/src/components/web/web-config.tsx`: 新增设计模型和代码生成模型的下拉选择 UI。
    - `apps/studio/src/components/assistants/web-architect/index.tsx`: 将新参数透传至 API。
    - `apps/studio/src/app/api/chat/web/route.ts`: 后端显式接收并传递新模型参数。
    - `apps/studio/src/assistants/web-architect/initial-gen.ts` & `refine-gen.ts`: 根据阶段动态使用不同模型。
- **默认配置**:
    - 设计模型: `Ling-2.5-1T` (擅长 UI/UX 规划)
    - 代码模型: `Ling-2.0-1T` (擅长逻辑实现与准确性)

## 修复的问题 (Bug Fixes)
- 修复了 `WebConfig.tsx` 中 `Code` 图标未导入导致的运行时 ReferenceError。
- 修复了后端 API 路由中 `config` 属性透传不全（漏掉新模型 ID）的问题。

## 对后续步骤的建议
- 考虑在 `MarkdownText` 组件中拦截包含工具协议的原始代码块，以实现更清爽的消息展示效果。
- 进一步优化 VFS 工具的自动化执行逻辑，尤其是在多文件并行读写场景下的冲突处理。
