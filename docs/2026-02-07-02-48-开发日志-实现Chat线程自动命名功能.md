# 2026-02-07-02-48-开发日志-实现Chat线程自动命名功能

## 背景

为了提升用户管理对话历史的效率，系统需要具备在首轮对话后自动为 Thread 命名的能力，替代单调的 "New Chat"。

## 来源文档

- [docs/2026-02-07-02-43-设计-Chat线程自动命名功能.md](./2026-02-07-02-43-设计-Chat线程自动命名功能.md)
- [docs/TODO.md](./TODO.md)

## 完成的功能点

### 1. 命名专用 Graph (`chat_name_generator`)
- 在 `app/lib/assistants/naming-graph.ts` 中实现。
- 强制使用 `Ling-Mini` 模型，确保极速响应。
- 专门设计的 System Prompt，引导模型输出 2-5 个词的精简标题，且不带引号和前缀。

### 2. 后端 API 路由 (`/api/naming`)
- 封装了对命名图的调用逻辑。
- 接收 AI SDK 格式的消息数组，并转换为 LangChain 格式进行处理。

### 3. 前端自动化组件 (`ThreadTitleAutomator`)
- 创建了 `components/thread-title-automator.tsx`。
- **监听机制**: 实时监控当前线程的消息长度和状态。
- **触发条件**: 消息数达到 2 条（一问一答）且当前标题为默认值时触发。
- **状态切换**:
    - 触发后立即调用 `runtime.threads.mainItem.rename("Naming...")` 提供视觉反馈。
    - 异步请求 API，成功后更新为生成的标题。
- **异常处理**: 若生成失败，保留或恢复为默认标题。

### 4. 全局集成
- 在 `app/assistant.tsx` 的 `AssistantRuntimeProvider` 中挂载了该组件，使其对所有 Chat 会话生效。

## 遇到的问题与修正

- **Hook 使用路径**: 确认了 `rename` 方法不在 `useThreadRuntime` 中，而是在 `useAssistantRuntime().threads.mainItem` 中。
- **Selector 模式**: 统一使用 `useThread((state) => state.messages)` 这种 Selector 模式以确保与当前库版本的兼容性。

## 后续建议

- **多轮优化**: 目前仅在第一轮后触发。若第一轮内容过少，可以考虑在第二轮后再次尝试重新命名。
- **手动覆盖**: 需确保用户手动修改过标题后，自动命名逻辑不再覆盖用户操作。
