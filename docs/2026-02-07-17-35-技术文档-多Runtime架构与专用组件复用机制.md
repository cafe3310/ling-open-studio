# 技术文档 - 多 Runtime 架构与专用组件复用机制

## 1. 概述 (Overview)
随着 `ling-open-studio` 扩展为多功能（Chat, Web, Write）工作台，单一的 Runtime 模式已无法满足需求。本文档描述了系统如何管理多个并行的 `AssistantRuntime`，以及如何实现业务专用组件的高效复用。

## 2. 多 Runtime 切换架构

### 2.1 状态提升设计
系统在 `app/assistant.tsx` 中集中管理所有业务 Runtime：
```typescript
const chatRuntime = useChatRuntime({ ... });
const webRuntime = useChatRuntime({ ... });
const activeRuntime = activeTab === 'web' ? webRuntime : chatRuntime;
```
**设计优势**：
1.  **稳定性**：避免了 `AssistantRuntimeProvider` 因频繁挂载/卸载导致的 React Fiber 错误。
2.  **持久性**：用户在 Tab 间切换时，未完成的对话和生成状态得以保留。

### 2.2 隔离原则
- **API 路径**：虽然目前共用 `/api/chat`，但通过 `body.config.mode` 字段在后端路由至不同的 LangGraph。
- **System Prompt**: 在顶层通过配置注入，确保 `Web Architect` 与 `General Assistant` 具有不同的角色人格。

## 3. 专用组件复用机制

### 3.1 可配置的 `Thread` 组件
为了在 Web 窄边栏和 Chat 宽屏下复用相同的交互逻辑，我们对 `Thread` 进行了增强：
- **`suggestions` Prop**: 支持注入 `WEB_SUGGESTIONS` 等业务专属示例。
- **CSS Scope**: 引入 `.aui-compact` 类，通过样式覆盖（Style JSX Global）调整窄屏下的字体大小和容器宽度。

### 3.2 预览区与 VFS 的嵌套
`WebPreview` 组件实现了“视图 - 源码”的双模切换：
- **Preview 模式**: 渲染 iframe 承载 VFS 产物。
- **Files 模式**: 嵌套 `FilesystemTab`。通过指定 `threadId="global"`，使得 Web 生成的产物与全局文件管理器的底层数据完全同步。

## 4. 扩展指南
若需增加新的业务 Tab（如 Model Write）：
1.  在 `app/assistant.tsx` 中创建新的 `writeRuntime`。
2.  更新 `activeRuntime` 的切换逻辑。
3.  在 `components/write/` 下创建业务 UI，复用 `Thread` 并传入专属 suggestions。
