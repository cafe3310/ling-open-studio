# 2026-02-07-02-59-设计-浏览器端虚拟文件系统 (VFS)

## 1. 背景与目标
为了支持 "Model Web" (网页生成与预览)、"Model Write" (写作协作) 以及未来的 AI Tool Calls (如读写本地文件)，系统需要在用户浏览器中实现一个持久化的虚拟文件系统 (Virtual File System, VFS)。

该 VFS 将允许 AI 和用户在当前对话线程 (Thread) 的上下文中创建、读取、更新和删除文件。

## 2. 核心需求
1.  **持久化存储**：使用 IndexedDB 存储文件内容，确保刷新页面后内容不丢失。
2.  **线程隔离**：文件操作以 `threadId` 为作用域，每个对话线程拥有独立的“工作区”。
3.  **支持多种文件类型**：包括 HTML, CSS, JS, Markdown, JSON 等。
4.  **高效的 API**：提供简单直观的 CRUD 接口，支持目录结构。
5.  **扩展性**：为未来集成工具调用 (Tool Calls) 预留接口。

## 3. 技术选型
- **底层存储**: IndexedDB (使用原生 API 的 Promise 封装)。
- **数据模型**: 
  - `files`: 存储文件元数据和内容。
  - `fileTree`: 存储目录结构（可选，初期可直接通过路径解析）。

## 4. 架构设计

### 4.1 数据结构 (Schema)
```typescript
interface VirtualFile {
  id: string;        // 唯一 ID
  threadId: string;  // 所属线程 ID
  path: string;      // 完整路径 (例如: /index.html)
  name: string;      // 文件名
  content: string | ArrayBuffer;
  type: string;      // 文件类型 (html, css, js, md...)
  size: number;
  createdAt: Date;
  updatedAt: Date;
}
```

### 4.2 核心类 `BrowserVFS`
- `init()`: 初始化数据库。
- `createFile(threadId, path, content)`: 创建新文件。
- `readFile(threadId, path)`: 读取文件内容。
- `updateFile(threadId, path, content)`: 更新现有文件。
- `deleteFile(threadId, path)`: 删除文件。
- `listDirectory(threadId, path)`: 列出指定目录下的所有文件。

### 4.3 存储适配器
参照 `osw-studio` 的设计，我们将实现一个 `VFSDatabase` 类来处理 IndexedDB 的低级操作。

## 5. UI 集成方案
- **预览模式**: 当用户在 "Model Web" 标签页时，从 VFS 中读取 `index.html` 及其依赖，并通过 `iframe` 进行实时渲染。
- **编辑器模式**: "Model Write" 将 VFS 中的 Markdown 文件内容加载到编辑器中。

## 6. TODO 列表

- [ ] **基础架构实现**：
    - [ ] 实现 `lib/vfs/database.ts` (IndexedDB 包装)
    - [ ] 实现 `lib/vfs/index.ts` (VFS 核心逻辑与类型定义)
- [ ] **React 集成**：
    - [ ] 实现 `hooks/use-vfs.ts` 方便组件调用。
- [ ] **功能验证**：
    - [ ] 在控制台手动验证 CRUD 操作。
    - [ ] 实现一个简单的文件列表展示组件。
- [ ] **高级特性** (后续)：
    - [ ] 集成到 AI Tool Call 流程。
    - [ ] 支持导出整个线程工作区为 ZIP。
