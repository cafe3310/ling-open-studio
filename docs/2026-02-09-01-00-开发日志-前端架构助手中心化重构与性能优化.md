# 2026-02-09-01-00-开发日志-前端架构助手中心化重构与性能优化

## 1. 背景 (Background)

在 Model Web（网页生成助手）的开发过程中，我们遇到了三个核心挑战：
1. **构建干扰**：根目录下的文档日志包含特殊的 CSS 类名片段，导致 Tailwind 和 Turbopack 扫描报错。
2. **渲染性能**：网页生成的输出内容极长且包含大量代码块，实时 Markdown 渲染导致界面严重卡顿。
3. **架构耦合**：多个助手的 Runtime 和 UI 逻辑混在 `StudioShell` 中，导致配置（如 Tool Paradigm）难以独立控制。

## 2. 主要工作 (Major Changes)

### 2.1 Monorepo 架构迁移
- **物理隔离**：项目迁移至 `pnpm workspace` 结构。Next.js 应用下沉至 `apps/studio`，根目录仅保留 `docs` 和工作区配置。
- **构建闭环**：彻底解决了 `docs/` 目录干扰构建的问题。
- **流水线适配**：更新了 GitHub Actions 和 `Dockerfile.hf`，对齐了 Next.js `standalone` 模式在 Monorepo 下的层级路径（`apps/studio/server.js`）。

### 2.2 前端助手中心化重构 (Assistant-Centric Architecture)
- **Runtime 解耦**：创建了 `GeneralChatAssistant` 和 `WebArchitectAssistant` 独立组件。每个助手拥有私有的 `AssistantRuntime` 实例。
- **UI 私有化**：为每个助手分配了专属的 `thread.tsx` 实现，支持深度定制。
- **逻辑锁定**：`WebArchitectAssistant` 内部锁定了 `text` (Delimited) 协议，不再受全局设置干扰。

### 2.3 Web 助手性能与体验优化
- **极简渲染器 (`WebMarkdownText`)**：针对 Web 场景定制了文本渲染逻辑。
    - 使用 `<pre>` 标签直接展示原始文本，保留换行和缩进。
    - **自动过滤协议块**：在渲染前自动剔除 `=== write_file ===` 等工具调用文本，仅保留自然语言描述和交互卡片。
    - **性能飞跃**：避开了海量 Markdown 标签解析的开销，长文本生成丝滑顺畅。
- **工具调用“静默模式”**：为 `ToolCallRenderer` 引入了 `silent` 属性。在 Web 模式下点击“执行”后不再回发确认消息，避免了不必要的 Graph 触发。

### 2.4 VFS 预览同步修复
- **事件通道对齐**：将 `WebPreview` 和 `FilesystemTab` 的监听作用域统一锁定为 `"global"`。
- **路径映射同步**：预览组件现在能正确识别 `/workspace/sessions/${threadId}/index.html` 路径，实现了“点击执行即刻刷新预览”的闭环。

## 3. 遇到的问题与修正 (Issues & Fixes)

- **Standalone 路径问题**：在 Monorepo 中，`server.js` 需要在特定的相对层级才能找到 `node_modules`。已通过调整 `Dockerfile` 和 GHA 打包脚本解决。
- **Assistant-UI v0.12 适配**：修正了 `threadId` 获取路径（`s.threads.mainThreadId`）和重命名方法（`aui.threadListItem().rename`）。
- **组件定义冲突**：修复了重构过程中因变量重复定义导致的编译错误。

## 4. 后续计划 (Next Steps)

- [ ] 开始开发 **Model Write** 助手（基于当前成熟的助手中心化架构）。
- [ ] 优化 `Filesystem` 详情面板，支持在文件列表直接打开预览。
- [ ] 增强 `WebArchitect` 的多文件生成能力。
