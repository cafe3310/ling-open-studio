# 2026-02-08-01-03-开发日志-完成半自动工具调用系统与VFS隔离架构

## 1. 背景 (Background)
为了提升 Agent 的实操能力，我们决定在 `ling-open-studio` 中引入两组核心工具：**浏览器 JS 执行** 和 **虚拟文件系统 (VFS)**。用户希望模型能够在受控、透明的环境下执行这些操作，并支持多种协议范式（JSON/XML）以适配不同能力等级的模型。

## 2. 完成项 (What's New)

### 2.1 协议化工具架构 (Prompt-Reinforced Paradigm)
- **多策略支持**: 实现了 `ToolContextDef` 接口及其两种实现：`ToolCtxJson` (针对强逻辑模型) 和 `ToolCtxXml` (针对推理/标签敏感模型)。
- **动态注入**: 在 `app/api/chat/route.ts` 中根据前端配置动态生成并注入增强后的 System Prompt，包含工具定义、使用协议和心智模型约束。
- **简化定义**: 工具结构被简化为包含 `argsDesc` 和 `fn` 的轻量级对象，极大降低了维护成本。

### 2.2 用户介导工具循环 (User-Mediated Tool Loop)
- **交互式渲染器**: 开发了 `ToolCallRenderer` 组件，监听消息状态并在生成结束后自动扫描协议内容。
- **Request | Result 并排视图**: 工具调用和结果现在以并排双栏卡片的形式展示，提供连贯的交易感。
- **智能过滤**: 升级了 `UserMessage` 渲染器，利用 Parser 接口剥离协议内容，自动隐藏冗余的原始 JSON/XML 结果消息。
- **状态感知**: 支持历史扫描，组件能自动识别历史消息中的结果并恢复 "Executed" 状态，完美支持“重新生成”场景。

### 2.3 挂载式 VFS 隔离 (Mount-Based Isolation)
- **虚拟路径映射**: 引入了 `MountMap` 概念。模型看到的根目录 `/` 实际上映射到了物理路径 `/workspace/sessions/${threadId}/`。
- **强制线程隔离**: 所有的 VFS 操作统一使用 `global` 线程存储，但通过包含 `threadId` 的物理路径实现真正的文件夹级别隔离。
- **递归列表**: 升级了 `list_directory` 工具，使其能够跨挂载点递归列出文件，支持反向路径映射。

### 2.4 UI 与品牌优化
- **品牌更名**: 页面及标题正式更名为 **Ling OpenStudio**。
- **配置面板**: 增加了工具开关和格式选择器，移除了冗余的状态监控部分。

## 3. 关键技术经验 (Key Technical Insights)

### 3.1 assistant-ui 深度实践
- **useMessage 结构**: 确认 `useMessage()` 返回的是消息对象本身，而非嵌套对象。通过 Selector 模式 (`useMessage(m => m.status)`) 可以获得最佳的性能和类型安全。
- **编程式消息追加**: 确定 `runtime.append(string)` 是最可靠的触发后端重新生成的路径。

### 3.2 路径安全与鲁棒性
- 通过在执行器层面注入 `threadId` 和 `basePath`，我们解决了 LLM 不稳定生成的“乱写文件”问题，同时满足了 VFS 的权限约束。

## 4. 下一步计划 (Next Steps)
- **ModelWeb 落地**: 基于 VFS 隔离架构，开始实现网页生成的实时预览功能。
- **更多工具**: 考虑引入网络搜索或多媒体处理工具。
- **持久化增强**: 优化 IndexedDB 在大规模文件操作下的性能。
