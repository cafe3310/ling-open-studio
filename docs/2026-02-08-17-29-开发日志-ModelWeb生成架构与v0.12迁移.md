# 2026-02-08-17-29-开发日志-ModelWeb生成架构与v0.12迁移

## 1. 背景 (Background)

本阶段的目标是实现 `ling-open-studio` 的核心差异化功能——**Model Web (网页生成)**。这是一个高度复杂的任务，需要协调前端配置、后端 Graph 编排、工具调用协议以及实时预览机制。

此外，为了保证项目的长久可维护性，我们决定同步进行 **assistant-ui v0.12** 的破坏性更新迁移。

## 2. 完成项 (What's New)

### 2.1 Model Web 核心架构 (Architecture)
- **双 Graph 策略**: 将生成过程拆分为 `InitialGenGraph` (Creation) 和 `RefineGenGraph` (Modification)，通过 `router` 动态分发。
    - **Initial Gen**: `Idea Expander` (PRD) -> `Style Director` (Visual Spec) -> `Code Generator` (Implementation).
    - **Refine Gen**: `Editor` (Read/Identify) -> `Resolver` (Write/Patch).
- **Delimited Blocks 协议**: 废弃了不可靠的 JSON 代码生成，采用 `=== tool: path ===` + `Content` 的定界块协议，极大提升了长文本（HTML/JS）生成的稳定性。
- **物理隔离**: 通过 `threadId` 将 VFS 路径隔离为 `/workspace/sessions/${threadId}/`，确保多任务并行不冲突。

### 2.2 上下文工程 (Context Engineering)
- **Prompt Registry**: 在 `assistants/web-architect/prompts/` 下建立了集中式的 Prompt 仓库。
    - `DesignOption`: 预设了 Swiss, Minimalist, Brutalist 等风格。
    - `TechStackOption`: 预设了 HTML+Tailwind 和 React (Browser-side) 技术栈。
- **Boilerplate Injection**: 在生成阶段强制注入“金标准”代码骨架，确保模型输出的代码结构正确且包含必要的 CDN。

### 2.3 前端闭环 (UI Integration)
- **WebConfig**: 实现了与 `Zustand` Store 的双向绑定，允许用户动态切换设计风格和技术栈。
- **WebPreview**: 基于 `useVFS` 和 `threadId` 实现了实时预览。
    - 监听 VFS 变更事件。
    - 使用 `iframe srcDoc` 安全渲染生成的 `index.html`。
- **Tool Registry**: 重构了工具策略加载逻辑，支持动态切换 JSON/XML/Text(Delimited) 范式。

### 2.4 Assistant-UI v0.12 迁移 (Migration)
- **Unified State API**: 全面迁移至 `useAui` 和 `useAuiState`，废弃了 `useThread`, `useThreadRuntime`, `useMessage` 等旧 Hook。
- **Event Naming**: 标准化为 camelCase。
- **Fixes**: 修正了 `ThreadTitleAutomator` 中对 `rename` API 的调用路径 (`aui.threads.mainItem.rename`)。

## 3. 技术细节与决策 (Technical Details)

### 3.1 为什么选择 Delimited Blocks?
JSON 在处理包含大量引号、换行和转义字符的代码块（如 HTML/JS）时非常脆弱，模型经常输出非法的 JSON 字符串。
Markdown 风格的定界块 (`=== write: /index.html ===`) 对模型更自然，且解析逻辑简单鲁棒（正则匹配），完全规避了转义地狱。

### 3.2 为什么需要 Registry?
随着工具范式（JSON/XML/Text）和 Prompt 策略（Design/TechStack）的增多，硬编码的 `if/else` 逻辑变得难以维护。
Registry 模式 (`lib/tools/registry.ts`, `assistants/.../prompts/index.ts`) 提供了类型安全、易于扩展的配置中心，符合开闭原则。

## 4. 下一步计划 (Next Steps)

- **End-to-End Testing**: 进行实际的网页生成测试，验证 Prompt 的有效性和预览的流畅度。
- **Console Log Capture**: 在预览窗口中捕获 `iframe` 的控制台日志，回传给 Graph 以支持自动 Debug。
- **Multi-file Support**: 虽然目前主要针对单文件生成进行了优化，但架构上已支持多文件读写，未来可扩展至多文件项目。
