# 2026-02-07-10-35-设计-VFS-详细数据结构与接口

## 1. 核心概念

VFS (Virtual File System) 是一个基于 IndexedDB 的浏览器端持久化文件系统。它以 `threadId` 为根作用域，允许在每个对话线程中维护独立的文件树。

## 2. 数据结构 (Data Structures)

### 2.1 文件类型定义 (`FileType`)
```typescript
export type FileType = 
  | 'text'      // 普通文本 (md, txt)
  | 'code'      // 代码 (js, ts, py)
  | 'html'      // HTML
  | 'css'       // 样式
  | 'json'      // 数据
  | 'image'     // 图片 (base64)
  | 'binary';   // 二进制
```

### 2.2 虚拟文件 (`VirtualFile`)
存储在 `files` Object Store 中。
```typescript
export interface VirtualFile {
  id: string;           // UUID，主键
  threadId: string;     // 所属线程 ID (索引)
  path: string;         // 完整路径，如 "/src/app.tsx" (复合索引: [threadId, path] 必须唯一)
  name: string;         // 文件名，如 "app.tsx"
  
  content: string | ArrayBuffer; // 文件内容
  
  type: FileType;       // 抽象文件类型
  mimeType: string;     // 具体的 MIME type
  size: number;         // 字节大小
  
  createdAt: number;    // 时间戳
  updatedAt: number;    // 时间戳
  
  metadata?: Record<string, any>; // 扩展元数据 (例如: 是否只读，来源消息ID等)
}
```

### 2.3 数据库 Schema (IndexedDB)
- **Database Name**: `ling-vfs-db`
- **Version**: `1`
- **Stores**:
    - `files`:
        - KeyPath: `id`
        - Indexes:
            - `threadId`: (non-unique) 用于查询某个线程的所有文件
            - `path_unique`: `[threadId, path]` (unique) 确保同一线程下路径唯一
            - `type`: (non-unique) 用于按类型过滤

## 3. 操作接口 (API Interface)

### 3.1 基础文件操作 (`FileOperations`)

```typescript
interface IVirtualFileSystem {
  /**
   * 初始化数据库连接
   */
  init(): Promise<void>;

  /**
   * 创建或覆盖文件
   * @param threadId 线程 ID
   * @param path 完整路径 (例如 "/index.html")
   * @param content 文件内容
   * @returns 创建的文件对象
   */
  writeFile(threadId: string, path: string, content: string | ArrayBuffer): Promise<VirtualFile>;

  /**
   * 读取文件内容
   * @param threadId 线程 ID
   * @param path 完整路径
   * @returns 文件对象，若不存在抛出异常
   */
  readFile(threadId: string, path: string): Promise<VirtualFile>;

  /**
   * 检查文件是否存在
   */
  exists(threadId: string, path: string): Promise<boolean>;

  /**
   * 删除文件
   */
  deleteFile(threadId: string, path: string): Promise<void>;

  /**
   * 重命名或移动文件
   */
  renameFile(threadId: string, oldPath: string, newPath: string): Promise<VirtualFile>;
  
  /**
   * 获取文件元信息 (不读取 content，用于列表展示优化)
   */
  stat(threadId: string, path: string): Promise<Omit<VirtualFile, 'content'>>;
}
```

### 3.2 目录与批量操作 (`DirectoryOperations`)

```typescript
interface IVirtualFileSystem {
  // ... existing methods

  /**
   * 列出指定目录下的所有文件 (浅层遍历)
   * @param threadId 线程 ID
   * @param dirPath 目录路径 (例如 "/src/")，默认为根目录 "/"
   * @returns 文件列表
   */
  listDir(threadId: string, dirPath?: string): Promise<VirtualFile[]>;

  /**
   * 递归获取线程下的所有文件
   * @param threadId 线程 ID
   * @returns 所有文件的列表
   */
  listAllFiles(threadId: string): Promise<VirtualFile[]>;

  /**
   * 删除整个目录 (递归)
   */
  deleteDir(threadId: string, dirPath: string): Promise<void>;
  
  /**
   * 清空整个线程的工作区
   */
  clearThread(threadId: string): Promise<void>;
}
```

## 4. 辅助工具与Hook

### 4.1 `useVFS` Hook
用于 React 组件中方便地操作 VFS。

```typescript
function useVFS(threadId: string) {
  const { isReady } = useVFSContext();
  
  // 状态
  const [files, setFiles] = useState<VirtualFile[]>([]);
  const [loading, setLoading] = useState(false);
  
  // 操作 (自动绑定 threadId)
  const writeFile = async (path: string, content: string) => { ... }
  const readFile = async (path: string) => { ... }
  const deleteFile = async (path: string) => { ... }
  
  // 订阅文件变化 (EventBus / Context)
  useEffect(() => {
    // Listen to changes...
  }, [threadId]);
  
  return { files, writeFile, readFile, deleteFile, loading };
}
```

## 5. 路径规范
- 路径必须以 `/` 开头。
- 不支持相对路径 (`../`)，所有路径在存储前必须标准化。
- 目录仅仅是路径的前缀概念，VFS 不单独存储 Directory 对象（为了简化实现，类似于 S3 的 Key 设计）。
  - 例如：存在文件 `/src/app.tsx` 意味着逻辑上存在目录 `/src/`。
  - `listDir("/src/")` 的实现方式是查询所有 `path` 以 `/src/` 开头且不包含后续 `/` 的文件。
