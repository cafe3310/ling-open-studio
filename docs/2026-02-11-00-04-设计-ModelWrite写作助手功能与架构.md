# 2026-02-11-00-04-设计-ModelWrite写作助手功能与架构 (全量版)

## 1. 背景 (Background)

"Model Write" 是一个面向创意写作的沉浸式 AI 编辑器。它通过结合长文本生成能力、实时上下文分析和灵感推荐，展示模型在复杂创作场景下的深度协作能力。

## 2. 视觉与排版规范 (Visual & Typography)

### 2.1 品牌色值
- **Ice Gray (BG)**: `#F8F9FB` - 用于侧边栏背景，营造专业、冷静的创作氛围。
- **Brand Dark (Text)**: `#1A1A1A` - 主要文字颜色，确保极高的可读性。
- **Action Blue (Primary)**: `#3B82F6` - 核心动作按钮、图标和活跃状态。
- **Tech Cyan / Slate**: 用于辅助标签和深度分析提示。

### 2.2 字体系统
- **Serif (Headings & Canvas)**: `Playfair Display` - 用于书名和编辑器正文，模拟纸张印刷的高级感。
- **Sans (UI)**: `Inter` - 用于功能说明、标签和输入框。

## 3. 功能模块详述 (Functional Modules)

### 3.1 智能触发体系 (Intelligent Trigger System)
我们将 AI 能力分为三个响应能级：
1.  **即时响应 (Input-triggered)**: 
    *   *功能*: 单句续写、自动补全。
    *   *机制*: 监听用户停顿（如 500ms），基于“微观记忆”快速预测。
2.  **主动决策 (Action-triggered)**:
    *   *功能*: 续写一段、选择剧情分支、重写当前段落。
    *   *机制*: 用户点击按钮触发，调用高参数模型进行逻辑创作。
3.  **静默观察 (Change-triggered)**:
    *   *功能*: 人物/实体提取、大纲一致性检查。
    *   *机制*: 随文档变更防抖触发（如 5s），更新 Session 存储中的知识库。

### 3.2 记忆与上下文管理 (Multi-granular Memory)
所有记忆内容均持久化于 VFS 路径 `/workspace/sessions/${threadId}/`：
-   **微观记忆 (Ephemeral)**: 缓存于内存中的滑动窗口（最近 1000 字）。
-   **中观记忆 (Session Knowledge)**: 存储于 `entities.json`。包含 AI 提取的角色状态、地理位置特征、关键道具列表。
-   **宏观记忆 (Global Specs)**: 存储于 `project.json`。由用户定义的大纲 (Outline)、世界观 (Lore) 和风格指南 (Style Guide)。

#### 3.2.1 核心原则：作者主权 (Author Sovereignty)
为了保护创作心流，系统遵循以下交互原则：
-   **动态顺应 (Dynamic Adaptation)**: 用户的最新输入永远是“第一真理”。如果当前描写与历史设定冲突，AI 应当静默更新其内部知识库 (`entities.json`)，而非向用户发出警告。
-   **权重倾斜**: 离光标位置越近的叙述拥有更高的认知权重。AI 在续写和生成灵感时，优先参考最新的角色状态与环境特征。
-   **无感辅助**: 所有的分析任务在后台静默完成，不打断用户的写作输入。

### 3.3 智能编辑器 (中间栏 - The Editor)
- **核心交互**:
    - **沉浸式 Canvas**: 纯净写作环境，支持 Playfair Display 优雅排版与 Markdown 语法。
    - **单句续写 (Inline Ghost Text)**: 
        *   *交互*: AI 预测内容以浅灰色“幻影文字”显示在光标后。
        *   *确认*: 用户按 `Tab` 键接受，或继续输入自动覆盖。
    - **灵感缝合 (Context-aware Insert)**: 
        *   *功能*: 点击右侧灵感卡片，系统根据当前光标前后的语义逻辑，自动调整卡片内容并平滑“缝合”插入。
    - **选中改写 (Selection-triggered Rewrite)**:
        *   *UI 表现*: 画布上方悬浮或固定的工具栏包含“Rewrite”、“Expand”、“Refine”按钮。
        *   *交互逻辑*: 初始为禁用状态，提示“Select text to enable AI actions”。当用户选中文字时激活，点击后针对选中区进行智能局部重写。

### 3.4 AI 智能辅助 (右侧栏 - AI Insights)
- **动态实体提取 (Detected Concepts)**: 
    - **机制**: 由“静默观察层”驱动，自动识别“角色”、“关键道具”、“核心地点”。
- **灵感卡片流 (Inspiration Cards)**:
    - **内容分发**: 涵盖 Plot (剧情扭转), Description (感官增强), Dialogue (对话建议)。
    - **生命周期**: 随着创作进度动态更新（防抖触发），确保建议永远贴合“当前创作前沿”。

## 4. 技术实现架构 (Technical Implementation)

### 4.1 数据流逻辑 (The Memory Loop)
1.  **用户写作** -> 触发 **Insight Graph (静默观察)**。
2.  **Insight Graph** 提取实体 -> 写入 VFS **`entities.json`**。
3.  **用户发起主动指令** -> **Writer Graph** 同时读取 **当前正文 + `entities.json` + `project.json`**。
4.  **Writer Graph** 产出内容 -> 流式回填编辑器。

### 4.2 状态管理 (Zustand)
- `writeStore`: 管理当前作品元数据、已提取的实体以及当前的灵感列表。

## 5. 接下来讨论的智能挑战 (Discussion Points)
- **流式回填体验**: 如何实现在 TipTap/Monaco 内部像“真人打字”一样的流式追加？
- **上下文窗口平衡**: 续写时如何动态裁切上文，以确保既保留关键设定又不超出 Token 限制？
- **多 Graph 协同**: 如何让 Writer 节点感知到 Insight 节点提取出的最新实体？
