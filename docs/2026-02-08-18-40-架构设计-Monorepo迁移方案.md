# 2026-02-08-22-38-架构设计-Monorepo迁移方案

## 1. 背景 (Background)

当前项目虽然采用了 `src/` 结构，但由于构建工具（Turbopack, Tailwind CSS v4）的自动扫描机制过于激进，根目录下的 `docs/` 文件夹（特别是包含代码片段的日志文件）频繁干扰构建过程，导致 CSS 解析错误。

为了实现源码与文档资源的**彻底物理隔离**，并为未来可能的多项目扩展（如独立的 `docs` 站点或 `shared-ui` 包）打下基础，我们决定将项目迁移至 **pnpm Monorepo** 架构。

## 2. 目标架构 (Target Architecture)

```text
/ling-open-studio (Root)
├── .git/
├── .github/                # CI/CD 流程
├── docs/                   # 项目文档与日志 (在此安全存放，不会被构建扫描)
├── package.json            # 根目录配置 (管理工作区脚本)
├── pnpm-workspace.yaml     # 工作区定义
└── apps/                   # 应用程序目录
    └── studio/             # 原 Next.js 项目主体
        ├── src/            # 源码 (app, components, lib, etc.)
        ├── public/         # 静态资源
        ├── package.json    # 项目依赖
        ├── next.config.ts  # Next.js 配置
        ├── tsconfig.json
        ├── postcss.config.mjs
        └── ...
```

## 3. 迁移步骤 (Migration Steps)

### 3.1 目录重组
1.  **创建结构**: 在根目录创建 `apps/studio` 文件夹。
2.  **移动文件**: 将除 `docs/`, `.git/`, `.github/`, `.idea/` 以外的所有项目文件移动到 `apps/studio/` 中。
    - 包括配置文件：`package.json`, `next.config.ts`, `tsconfig.json`, `.env.*` 等。
    - 包括源码目录：`src/`, `public/`。

### 3.2 根目录配置
1.  **`pnpm-workspace.yaml`**:
    ```yaml
    packages:
      - "apps/*"
    ```
2.  **根目录 `package.json`**:
    创建一个精简的 `package.json`，用于管理全局脚本和 Husky 等工具。
    ```json
    {
      "name": "ling-open-studio-monorepo",
      "private": true,
      "scripts": {
        "dev": "pnpm -F studio dev",
        "build": "pnpm -F studio build",
        "lint": "pnpm -F studio lint"
      }
    }
    ```

### 3.3 子项目配置修正
1.  **`apps/studio/package.json`**:
    - 将 `name` 修改为 `@ling/studio`（可选，便于识别）。
    - 确保 `dev` 脚本端口正确（Next.js 默认 3000）。

### 3.4 构建流水线适配
1.  **Dockerfile (`Dockerfile.hf`)**:
    - 需移动到 `apps/studio/` 内部，或调整 `COPY` 指令。
    - **决策**: 将 Dockerfile 移动到 `apps/studio/Dockerfile.hf`，保持其作为独立应用的构建逻辑。
2.  **GitHub Actions (`deploy-hf.yml`)**:
    - `working-directory` 需要调整，或构建命令改为 `pnpm -F studio build`。
    - 产物路径将变更为 `apps/studio/.next/...`。

## 4. 预期收益 (Benefits)

- **构建隔离**: Next.js 和 Tailwind 的运行上下文被物理限制在 `apps/studio` 目录下。根目录的 `docs/` 对它们完全不可见。
- **扩展性**: 未来可以轻松添加 `packages/ui` (共享组件库) 或 `apps/docs` (VitePress 文档站)。
- **依赖清晰**: 根目录只负责编排，子应用管理各自的依赖。

## 5. 验证计划 (Verification)

- [ ] 执行迁移脚本。
- [ ] 在根目录运行 `pnpm install`。
- [ ] 运行 `pnpm dev`，验证 `studio` 应用是否正常启动。
- [ ] 修改 `docs/` 下的文件，验证是否还会触发 Tailwind 重新构建或报错。
