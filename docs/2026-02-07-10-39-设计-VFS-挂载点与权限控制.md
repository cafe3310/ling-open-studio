# 2026-02-07-10-39-设计-VFS-挂载点与权限控制

## 1. 背景
为了支持更复杂的应用场景（如 Skill 资源管理、网页生成模版、小说世界观设定），VFS 需要引入分区管理。核心需求是将文件系统划分为“AI 可写”的工作区和“AI 只读”的资源/系统区。

## 2. 分区与挂载点设计 (Partitions & Mount Points)

VFS 将逻辑上划分为不同的区域，通过**路径前缀**来区分。

### 2.1 区域定义

| 区域名称 | 路径前缀 | 权限 (Chat AI) | 权限 (User UI) | 用途 |
| :--- | :--- | :--- | :--- | :--- |
| **工作区 (Workspace)** | `/workspace/` | **R/W** (读写) | **R/W** (读写) | 存放用户项目代码、小说章节、生成的网页等。AI 的主要活动区域。 |
| **系统资源 (System)** | `/system/` | **R** (只读) | **R/W** (读写) | 存放 Agent Skills、预置模版、全局配置、知识库/设定集。AI 可读取参考，但不可修改。 |
| **临时区 (Tmp)** | `/tmp/` | **R/W** (读写) | **Hidden** | (可选) 存放中间产物，会定期清理。 |

**注意**: 所有 API 调用时传入的 `path` 必须以这些前缀之一开头。

## 3. 数据结构更新

### 3.1 虚拟文件 (`VirtualFile`)
增加 `isReadOnly` 标记作为辅助，但主要权限由路径策略决定。

```typescript
export interface VirtualFile {
  // ... existing fields
  
  // 权限标记 (可用于 UI 展示锁图标，或特殊覆盖策略)
  isReadOnly?: boolean; 
}
```

## 4. 接口层权限校验 (`Permission Guard`)

在 VFS 核心类中实现拦截器。

```typescript
class BrowserVFS implements IVirtualFileSystem {
  
  /**
   * 检查是否允许写入
   * @param path 目标路径
   * @param source 操作来源 ('user' | 'agent') - 默认为 'agent' 如果未指定
   */
  private checkWritePermission(path: string, source: 'user' | 'agent' = 'agent'): void {
    if (source === 'user') return; // 用户拥有上帝权限

    if (path.startsWith('/system/')) {
      throw new Error(`Permission Denied: Agent cannot modify system files at ${path}`);
    }
    
    // 可以扩展更多规则，例如锁定特定的 /workspace/.config 文件
  }

  async writeFile(threadId: string, path: string, content: any, source: 'user' | 'agent' = 'agent') {
    this.checkWritePermission(path, source);
    // ... proceed to write
  }
  
  async deleteFile(threadId: string, path: string, source: 'user' | 'agent' = 'agent') {
    this.checkWritePermission(path, source);
    // ... proceed to delete
  }
}
```

## 5. 场景映射

### 5.1 网页 Coder 场景
- **模版加载**: 系统启动时，将 `react-template` 写入 `/system/templates/react/` (User 权限)。
- **代码生成**: AI 读取模版，根据用户需求，在 `/workspace/src/App.tsx` 生成代码 (Agent 权限)。
- **预览**: Preview 组件监听 `/workspace/` 下的文件变更进行热更新。

### 5.2 小说编写场景
- **设定注入**: 用户上传“世界观设定.md”到 `/system/knowledge/world.md`。
- **写作**: AI 读取 `/system/knowledge/world.md` 获取背景知识。
- **产出**: AI 将新生成的章节写入 `/workspace/chapter-1.md`。
- **修订**: 用户对 `/workspace/chapter-1.md` 进行手动修改 (User 权限)。

## 6. 更新后的 TODO

- [ ] **基础架构**：
    - [ ] 实现 `lib/vfs/database.ts` (IndexedDB)
    - [ ] 实现 `lib/vfs/index.ts` (包含路径校验和权限拦截逻辑)
- [ ] **React 集成**：
    - [ ] `useVFS` Hook (需支持传入 `source` 参数以区分用户操作和AI操作)
- [ ] **初始化逻辑**：
    - [ ] 实现 `bootSystem` 逻辑，确保 `/system/` 和 `/workspace/` 目录存在或被初始化。
