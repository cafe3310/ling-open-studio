# 2026-02-22-22-28-逻辑增补-ModelWrite功能与交互细化

## 1. 来源文档 (Source)
- [[2026-02-22-22-10-设计-ModelWrite写作助手功能与UI全量梳理]]
- [[2026-02-22-22-11-设计-ModelWrite写作助手State全量梳理]]
- [[2026-02-22-22-12-设计-ModelWrite智能体架构与Graph流程全量梳理]]

## 2. 逻辑增补 (Logic Supplements)

### 2.1 片段提取规则 (Segment Extraction)
*   **提取逻辑**: 以 **自然段 (Natural Paragraph)** 为基础单位。
*   **触发器**: 
    1.  当用户按下 `Enter` 产生新行时，旧行即刻被提取为一个独立的 `TextSegment`。
    2.  当光标通过键盘或点击离开当前编辑的段落时，触发 `SegmentPreprocessor`。
*   **状态回溯**: 如果用户返回已处理 (`completed`) 的片段并进行修改，该片段的状态即刻回滚为 `raw`，并重新进入预处理队列。

### 2.2 多层级推理阻塞 (Granular Inference Blocking)
为了提升交互的精准反馈，除了 `runtime.isGenerating` 全局标志外，每个具备推理能力的模块均需维护独立的阻塞状态：

| 模块 | 状态字段 (State Flag) | UI 表现 (Visual Effect) |
| :--- | :--- | :--- |
| **写作画布** | `isCanvasProcessing` | 当前段落出现 `text-amber-600/50` 琥珀色淡入效果。 |
| **左侧设定集** | `isLoreKeeperRunning` | 知识库侧边栏显示微型 `Sparkles` 闪烁动画及虚线边框增强。 |
| **灵感卡片区** | `isMuseWhisperRunning` | 整个灵感列表区域出现一层半透明的 `Action Blue` 渐变边框，并提示“正在捕捉缪斯...”。 |
| **详情弹窗** | `isEntryDrafting` | `EntryDialog` 右侧建议区展示骨架屏 (Skeleton) 或 `CircleDashed` 旋转动画。 |

### 2.3 调试器增强 (Debugger/StatusViewer)
*   **推理指示器**: `WriteStatusViewer` 展开后，不仅显示 Graph 状态，还应直观显示当前是哪个具体的前端组件触发了该推理。
*   **全局日志功能 (Global Log Viewer)**:
    *   **触发**: 在调试器中增加一个“查看全局日志”按钮。
    *   **展示内容**: 
        1.  **Request**: 完整的请求 Body（包含上下文、System Prompt）。
        2.  **Roles**: 展示当前 Graph 涉及的各个节点角色及其权重。
        3.  **Response**: 原始的推理输出及中间思考过程 (Reasoning)。
    *   **UI 表现**: 弹出一个宽屏 Modal，支持按时间戳过滤和一键复制 Prompt。

### 2.4 用户主权与冲突处理 (Author Sovereignty)
*   **静默同步**: 当用户的即兴创作与历史设定冲突时，系统优先记录用户的新内容，由 `LoreKeeper` 在后台静默对 `knowledgeBase` 进行增量修正，而非在写作区弹出警告，确保心流不被打断。
