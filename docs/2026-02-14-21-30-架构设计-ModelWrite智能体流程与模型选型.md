# 2026-02-14-21-30-架构设计-ModelWrite智能体流程与模型选型

## 1. 背景 (Background)

Model Write 的 UI 架构已定型，包含左侧设定集、中间写作画布和右侧灵感/工具区。为了驱动这些界面元素，我们需要定义底层的智能体架构。本文档旨在规范数据结构，并为每个交互点设计独立的 LangGraph 流程及模型选型策略。

## 2. 核心数据结构 (Core Schema)

在定义 Graph 之前，必须明确 Agent 运行时可访问的上下文数据结构。

### 2.1 写作会话状态 (WriteSessionState)
```typescript
interface WriteSessionState {
  // 基础元数据
  metadata: {
    title: string;
    summary: string; // 用户编辑的大纲
  };

  // 核心正文
  document: {
    content: string; // 完整的 Markdown 内容
    cursorOffset: number; // 光标位置
    selection: { start: number; end: number } | null; // 选中区域
  };

  // 知识库 (对应左侧边栏)
  knowledgeBase: {
    worldSettings: KnowledgeEntry[];
    characters: KnowledgeEntry[];
    concepts: KnowledgeEntry[];
  };

  // 运行时状态 (对应右侧边栏)
  runtime: {
    activeInspirations: string[]; // 当前生效的灵感卡片 ID 列表
    ghostText: string | null; // 画布上的幻影文字
    isGenerating: boolean;
  };
}

interface KnowledgeEntry {
  id: string;
  name: string;
  type: 'manual' | 'auto'; // 实色 vs 浅色
  definition: string; // 正式定义
  aiSuggestions: string[]; // 待采纳的建议碎片
  status: 'active' | 'archived';
}
```

## 3. 智能功能注册表 (Intelligence Registry)

我们将页面上的智能功能点抽象为以下 5 个独立的 Agent/Graph：

| UI 交互点 | 代号 (Code Name) | 功能描述 | 触发机制 | 延迟容忍度 |
| :--- | :--- | :--- | :--- | :--- |
| Canvas 打字停顿 | **PhantomWeaver** | 短语/半句级别的自动补全 (Ghost Text) | 键盘停顿 (Debounce 600ms) | 极低 (< 500ms) |
| 右侧 "Continue" | **NarrativeFlow** | 续写下一段落，遵循大纲和灵感 | 主动点击 | 中等 (~2-5s) |
| 左侧 Knowledge Base | **LoreKeeper** | 静默分析全文，提取实体与设定 | 文档变更 (Debounce 5s) | 高 (后台运行) |
| 右侧 Inspirations | **MuseWhisper** | 基于当前上下文生成剧情/描写灵感 | 主动点击刷新 / 定时推荐 | 中等 (~2s) |
| 左侧 Dialog 详情 | **DetailSculptor** | 为特定条目生成描述建议碎片 | 打开 Dialog 或点击刷新 | 低 (~1s) |

## 4. LangGraph 流程设计与模型选型

### 4.1 PhantomWeaver (幻影编织者)
*   **目标**: 提供极致响应速度的行内补全，维持心流。
*   **输入**:
    *   `cursorContext`: 光标前 500 字符 + 光标后 200 字符 (滑动窗口)。
    *   `activeInspirations`: 仅取 title。
*   **流程**:
    1.  **ContextTrimmer**: 快速截取滑动窗口。
    2.  **FastPredict**: 单次 LLM 调用。
*   **模型选型**: **Ling-Flash (或 Qwen-2.5-7B-Instruct)**
    *   *理由*: 极高的推理速度是唯一指标。不需要深度逻辑，只需局部通顺。

### 4.2 NarrativeFlow (叙事流)
*   **目标**: 产出高质量、符合设定、受灵感引导的正文段落。
*   **输入**:
    *   `document`: 全文 (或最近 5k tokens)。
    *   `summary`: 全局大纲。
    *   `knowledgeBase`: 激活的/相关的设定条目。
    *   `activeInspirations`: 强指令约束 (Instruction)。
*   **流程**:
    1.  **ContextRetriever**: 根据当前光标位置，检索相关的 Knowledge Entries (RAG)。
    2.  **InstructionBuilder**: 将 Summary 和 Active Inspirations 转化为 System Prompt。
    3.  **DraftWriter**: 流式生成内容。
*   **模型选型**: **Ling-Pro (或 Claude-3.5-Sonnet / GPT-4o)**
    *   *理由*: 需要极强的指令遵循能力（确保灵感卡片被执行）和优秀的文学表现力。

### 4.3 LoreKeeper (知识守夜人)
*   **目标**: 维护世界观一致性，自动发现新实体。
*   **输入**:
    *   `document`: 全文。
    *   `existingEntities`: 当前知识库列表 (用于去重)。
*   **流程**:
    1.  **ChangeAnalyzer**: 分析最近变更的文本块。
    2.  **EntityExtractor**: 提取潜在的新角色、地点或概念。
    3.  **ConsistencyChecker**: 检查新内容是否与旧设定冲突（可选，高级功能）。
    4.  **DatabaseUpdate**: 更新 `knowledgeBase` (标记为 `type: 'auto'`)。
*   **模型选型**: **Ling-Ultra (或 Gemini-1.5-Pro / GPT-4-Turbo)**
    *   *理由*: 需要超长上下文窗口来理解全文逻辑，且以后台异步方式运行，对延迟不敏感，追求召回率和准确性。

### 4.4 MuseWhisper (缪斯低语)
*   **目标**: 在卡文时提供破局思路，或增强感官描写。
*   **输入**:
    *   `document`: 最近 2k tokens。
    *   `summary`: 下一章的大纲规划。
*   **流程**:
    1.  **StateAnalyzer**: 分析当前剧情的紧张度 (Tension) 和情感色彩 (Sentiment)。
    2.  **IdeaGenerator**: 并行生成 Plot, Description, Dialogue 三类卡片。
    3.  **Filter**: 过滤掉与上文重复的建议。
*   **模型选型**: **Ling-Pro (或 Claude-3.5-Sonnet)**
    *   *理由*: 需要发散性思维和创意能力。

### 4.5 DetailSculptor (细节雕刻师)
*   **目标**: 辅助用户完善设定集的详细描述。
*   **输入**:
    *   `entryName`: 条目名称 (e.g., "Sir Arthur")。
    *   `currentDefinition`: 用户已写的定义。
    *   `documentContext`: 该条目在正文中出现的片段。
*   **流程**:
    1.  **TraitMiner**: 基于正文上下文，挖掘该条目的潜在特征。
    2.  **SuggestionFormatter**: 格式化为短语列表 (e.g., "Scarred left eye", "Carries a broken blade")。
*   **模型选型**: **Ling-Flash (或 Llama-3-8B)**
    *   *理由*: 任务简单明确（文本摘要与提取），追求交互的即时反馈感。

## 5. 总结 (Summary)

| Agent | 模型层级 | 关键特性 |
| :--- | :--- | :--- |
| **PhantomWeaver** | Edge/Flash | 速度优先，滑动窗口上下文 |
| **NarrativeFlow** | SOTA/Pro | 质量优先，指令遵循，RAG 集成 |
| **LoreKeeper** | Context/Ultra | 全文理解，异步后台，长窗口 |
| **MuseWhisper** | SOTA/Pro | 创意发散，多维分析 |
| **DetailSculptor** | Edge/Flash | 即时反馈，特定任务微调 |
