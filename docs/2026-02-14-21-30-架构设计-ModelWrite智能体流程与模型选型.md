# 2026-02-14-21-30-æ¶æ„è®¾è®¡-ModelWriteæ™ºèƒ½ä½“æµç¨‹ä¸æ¨¡å‹é€‰å‹

## 1. èƒŒæ™¯ (Background)

Model Write çš„ UI æ¶æ„å·²å®šå‹ï¼ŒåŒ…å«å·¦ä¾§è®¾å®šé›†ã€ä¸­é—´å†™ä½œç”»å¸ƒå’Œå³ä¾§çµæ„Ÿ/å·¥å…·åŒºã€‚ä¸ºäº†é©±åŠ¨è¿™äº›ç•Œé¢å…ƒç´ ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰åº•å±‚çš„æ™ºèƒ½ä½“æ¶æ„ã€‚æœ¬æ–‡æ¡£æ—¨åœ¨è§„èŒƒæ•°æ®ç»“æ„ï¼ˆåŒºåˆ†åŸå§‹æ•°æ®ä¸è¡ç”ŸçŠ¶æ€ï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªäº¤äº’ç‚¹è®¾è®¡ç‹¬ç«‹çš„ LangGraph æµç¨‹ã€Mermaid å›¾ç¤ºåŠæ¨¡å‹é€‰å‹ç­–ç•¥ã€‚

## 2. æ ¸å¿ƒæ•°æ®ç»“æ„ (Core Schema)

### 2.1 åŸå§‹æ•°æ® (Source Data)
è¿™äº›æ•°æ®æ˜¯æŒä¹…åŒ–çš„çœŸç›¸æ¥æºï¼Œç›´æ¥å†³å®š UI çš„å‘ˆç°ã€‚

```typescript
interface WriteSessionState {
  metadata: {
    title: string;
    summary: string;
  };
  document: {
    content: string;
    cursorOffset: number;
    selection: { start: number; end: number } | null;
  };
  knowledgeBase: {
    worldSettings: KnowledgeEntry[];
    characters: KnowledgeEntry[];
    concepts: KnowledgeEntry[];
  };
  runtime: {
    activeInspirationIds: string[];
    ghostText: string | null;
    isGenerating: boolean;
  };
}
```

### 2.2 è¡ç”ŸçŠ¶æ€ (Derived Context)
è§¦å‘ LLM æµç¨‹æ—¶åŠ¨æ€è®¡ç®—çš„ä¸Šä¸‹æ–‡ã€‚

```typescript
interface DerivedWriteContext {
  semantics: {
    lastSentence: string;
    lastParagraph: string;
    currentSentence: string;
    currentParagraph: string;
    surroundingContext: string;
  };
  activeEntries: KnowledgeEntry[];
  activeInspirations: InspirationCard[];
}
```

## 3. LangGraph æµç¨‹è®¾è®¡

### 4.1 PhantomWeaver (å¹»å½±ç¼–ç»‡è€…)
**ç›®æ ‡**: æè‡´å“åº”é€Ÿåº¦çš„è¡Œå†…è¡¥å…¨ã€‚

```mermaid
graph LR
    Input([Input: surroundingContext, activeInspirations]) --> Trimmer[Node: ContextTrimmer
Type: Logic/Regex]
    Trimmer --> Predict[Node: FastPredict
Type: LLM - Ling-Flash]
    Predict --> Output([Output: ghostText])
```
- **è¾“å…¥**: `DerivedContext.semantics.surroundingContext`, `DerivedContext.activeInspirations` (å–æ ‡é¢˜)ã€‚
- **è¾“å‡º**: `ghostText: string` (æ¨èè¡¥å…¨çš„åç»­æ–‡æœ¬)ã€‚

ğŸŸ¥ è¾“å…¥æ”¹æˆ 1.summaryï¼Œ 2. å½“å‰æ®µï¼Œ 3. åç»­æ®µï¼Œ 4. å½“å‰å¥å­ï¼ˆå…‰æ ‡ä¹‹å‰ï¼‰ 5.å¯ç”¨çš„çµæ„Ÿå¡ç‰‡å†…å®¹ï¼› 6. å‰è¿°éƒ¨åˆ†åŒ¹é…çš„ knowledge entry çš„ç›¸å…³å†…å®¹ã€‚
ğŸŸ¥ æ•´ä¸ªæµç¨‹ï¼š 1. å†…å®¹æ”¶é›†å’Œå¤„ç†èŠ‚ç‚¹ï¼ˆä»£ç ï¼‰ 2. æ¨ç†èŠ‚ç‚¹ï¼ˆllmï¼‰ 3. æœ‰æ•ˆæ€§è¿‡æ»¤èŠ‚ç‚¹ï¼Œå¦‚æœå†…å®¹æ˜æ˜¾ä¸åˆç†åˆ™è£å‰ªçŸ­ï¼ˆä»£ç ï¼‰

---


### 4.2 NarrativeFlow (å™äº‹æµ)
**ç›®æ ‡**: é«˜è´¨é‡æ®µè½ç»­å†™ã€‚

```mermaid
graph TD
    Input([Input: content, summary, activeEntries, activeInspirations]) --> Synthesizer[Node: ContextSynthesizer
Type: Prompt Template]
    Synthesizer --> Writer[Node: DraftWriter
Type: LLM - Ling-Pro]
    Writer --> Output([Output: newParagraph - Streamed])
```
- **è¾“å…¥**: `SourceData.document.content`, `SourceData.metadata.summary`, `DerivedContext.activeEntries`, `DerivedContext.activeInspirations` (å¯¹è±¡å…¨é‡å†…å®¹)ã€‚
- **è¾“å‡º**: `ReadableStream` (æµå¼è¿”å›çš„æ–°æ®µè½å†…å®¹)ã€‚

ğŸŸ¥ è¾“å…¥ï¼š1. summary 2. å½“å‰æ®µè½å†…å®¹ 3. æ‰€æœ‰ç”¨æˆ·æ‰‹åŠ¨çš„knowledge entry 4. å¯ç”¨çš„çµæ„Ÿå¡ç‰‡å†…å®¹ 5. å‰é¢éƒ¨åˆ†çš„æ¯æ®µæ‘˜è¦
ğŸŸ¥ æ•´ä¸ªæµç¨‹ï¼š 1. å†…å®¹æ”¶é›†å’Œå¤„ç†ï¼ˆä»£ç ï¼‰ 2. å‹ç¼©å‰è¿°éƒ¨åˆ†æ‘˜è¦ï¼ˆLLMï¼‰ 3. æ¨ç†ç»­å†™ï¼ˆLLMï¼‰ 4. æœ‰æ•ˆæ€§è¿‡æ»¤ï¼ˆä»£ç ï¼‰

---


### 4.3 LoreKeeper (çŸ¥è¯†å®ˆå¤œäºº)
**ç›®æ ‡**: å…¨æ–‡å®ä½“æå–ä¸è®¾å®šç»´æŠ¤ã€‚

```mermaid
graph TD
    Input([Input: fullContent, knowledgeBase]) --> Analyzer[Node: ChangeAnalyzer
Type: Diff Logic]
    Analyzer --> Extractor[Node: EntityExtractor
Type: LLM - Ling-Ultra]
    Extractor --> CrossRef[Node: CrossReferencer
Type: LLM/Logic]
    CrossRef --> Output([Output: updatedKnowledgeBase])
```
- **è¾“å…¥**: `SourceData.document.content` (å…¨é‡), `SourceData.knowledgeBase` (å­˜é‡å»é‡)ã€‚
- **è¾“å‡º**: `KnowledgeEntry[]` (æ–°å¢æˆ–æ›´æ–°çš„è‡ªåŠ¨åŒ–æå–æ¡ç›®)ã€‚

ğŸŸ¥ è¾“å…¥ï¼š1. summary, 2. ã€Œæœªç»å¤„ç†çš„æ®µè½ï¼ˆæ–°æ¦‚å¿µï¼‰ã€å†…å®¹ï¼Œ3. å½“å‰æ‰‹åŠ¨çš„knowledge entry 4.å½“å‰æ¨æ–­çš„knowledge entry 5. å‰é¢éƒ¨åˆ†çš„æ¯æ®µæ‘˜è¦
ğŸŸ¥ æ•´ä¸ªæµç¨‹ï¼š 1. å†…å®¹æ”¶é›†å’Œå¤„ç†ï¼ˆä»£ç ï¼‰2. å®ä½“åç§°æå–ï¼ˆLLMï¼‰ 3. å®ä½“å®šä¹‰æå–ï¼ˆLLMï¼‰ 4. è¿‡æ»¤å’Œç°æœ‰å®ä½“å»é‡ï¼ˆä»£ç ï¼‰

---


### 4.4 MuseWhisper (ç¼ªæ–¯ä½è¯­)
**ç›®æ ‡**: åŠ¨æ€ç”Ÿæˆåˆ›æ„çµæ„Ÿå¡ç‰‡ã€‚

```mermaid
graph TD
    Input([Input: lastParagraph, summary]) --> Theme[Node: ThemeAnalyzer
Type: LLM - Ling-Flash]
    Theme --> GenParallel{Parallel Node: CreativeGenerator
Type: LLM - Ling-Pro}
    GenParallel --> Plot[Plot Card]
    GenParallel --> Desc[Description Card]
    GenParallel --> Diag[Dialogue Card]
    Plot & Desc & Diag --> Output([Output: inspirationCards])
```
- **è¾“å…¥**: `DerivedContext.semantics.lastParagraph`, `SourceData.metadata.summary`ã€‚
- **è¾“å‡º**: `InspirationCard[]` (åŒ…å«ç±»å‹ã€æ ‡é¢˜ã€å†…å®¹çš„å¡ç‰‡åˆ—è¡¨)ã€‚

ğŸŸ¥è¾“å…¥ï¼š 1. summary 2. å½“å‰æ®µè½å†…å®¹ 3. å‰é¢éƒ¨åˆ†çš„æ¯æ®µæ‘˜è¦ï¼Œ4. å½“å‰å¯ç”¨çš„knowledge entry
ğŸŸ¥æ•´ä¸ªæµç¨‹ï¼š 1. å†…å®¹æ”¶é›†å’Œå¤„ç†ï¼ˆä»£ç ï¼‰ 2. ä¸»é¢˜åˆ†æï¼ˆLLMï¼‰ 3. åˆ›æ„ç”Ÿæˆï¼ˆLLMï¼Œåˆ†æ”¯ç”Ÿæˆä¸åŒç±»å‹çš„å¡ç‰‡ï¼‰ 4. æœ‰æ•ˆæ€§è¿‡æ»¤ï¼ˆä»£ç ï¼‰

---


### 4.5 DetailSculptor (ç»†èŠ‚é›•åˆ»å¸ˆ)
**ç›®æ ‡**: è¾…åŠ©å®Œå–„è®¾å®šé›†æ¡ç›®ã€‚

```mermaid
graph LR
    Input([Input: TargetEntry, surroundingContext]) --> Extractor[Node: FeatureExtractor
Type: LLM - Ling-Flash]
    Extractor --> Formatter[Node: FragmentGenerator
Type: Logic]
    Formatter --> Output([Output: aiSuggestions])
```
- **è¾“å…¥**: `KnowledgeEntry` (å½“å‰ç¼–è¾‘å¯¹è±¡), `DerivedContext.semantics.surroundingContext` (è¯­ä¹‰å…³è”ç‰‡æ®µ)ã€‚
- **è¾“å‡º**: `string[]` (æè¿°ç‰¹å¾ç¢ç‰‡åˆ—è¡¨)ã€‚

ğŸŸ¥è¿™ä¸ªä¸ç”¨å•ç‹¬ä¸€æ¡æµç¨‹ï¼Œç›´æ¥æ•´åˆåœ¨ LoreKeeper é‡Œã€‚ç”Ÿæˆçš„æ—¶å€™åŠ å…¥ä¸€äº›éšæœºèµ°å‘ï¼Œæä¾›ä¸€ç³»åˆ—å¯èƒ½çš„åç»­è®¾å®šã€‚


-------

ğŸŸ¥è¿˜å°‘å†™äº†ä¸¤ä¸ªæµç¨‹ï¼š1. å·²é€‰ä¸­éƒ¨åˆ†rewriter, 2. å·²é€‰ä¸­å†…å®¹ expander



## 4. æ¨¡å‹é€‰å‹æ€»ç»“ (Model Selection)

| Agent | æ¨¡å‹å±‚çº§ | æ ¸å¿ƒæŒ‡æ ‡ | å»¶è¿Ÿè¦æ±‚ |
| :--- | :--- | :--- | :--- |
| **PhantomWeaver** | Ling-Flash | æ¨ç†å»¶è¿Ÿ | < 500ms |
| **NarrativeFlow** | Ling-Pro | æŒ‡ä»¤éµå¾ªã€åˆ›æ„æ–‡å­¦æ€§ | < 3000ms (Start) |
| **LoreKeeper** | Ling-Ultra | ä¸Šä¸‹æ–‡çª—å£ã€å‡†ç¡®ç‡ | N/A (Background) |
| **MuseWhisper** | Ling-Pro | é€»è¾‘å‘æ•£ã€æƒ…æ„Ÿåˆ†æ | < 2000ms |
| **DetailSculptor** | Ling-Flash | æå–é€Ÿåº¦ | < 1000ms |


