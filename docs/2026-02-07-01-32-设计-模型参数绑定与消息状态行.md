# 2026-02-07-01-32-设计-模型参数绑定与消息状态行

## 背景与目标

用户希望将右侧 "Model Config" 面板中的参数（模型选择、系统提示词、温度）真正绑定到后端的推理逻辑中，并在 UI 上实现特定的交互限制（首条消息后禁用配置）。此外，需要在每条消息顶部增加状态行，显示使用的模型名称和首字延迟。

## 需求详情

### 1. 参数绑定 (Model Config Binding)
- **参数范围**:
    - **Model Selection**: 之前定义的 6 个模型。
    - **System Prompt**: 也就是 System Message。
    - **Temperature**: 默认值 `0.6`，范围 `0.0` - `1.4`。
- **交互限制**:
    - 在对话开始前（`messages.length === 0`）允许修改 Model Selection 和 System Prompt。
    - 一旦用户发送第一条消息，这两个选项变为 **Disabled**。
    - 鼠标悬停在禁用选项上时，显示 Tooltip 解释原因。
    - Temperature 允许随时调整（通常影响下一条消息，但在此上下文中用户未明确限制，假设允许随时调？用户原文："不允许在对话的一开始...改变...一旦用户发出信息...变禁用"。通常 System Prompt 确实很难中途变，但 Temperature 可以。根据用户描述，"这两个选项"指代 Model 和 System Prompt。Temperature 似乎未被包含在禁用列表中，保持开启）。

### 2. 后端集成
- 前端 `AssistantChatTransport` 需将上述配置随请求发送给 `/api/chat`。
- 后端 `/api/chat` 需解析这些参数。
- LangGraph 节点需根据参数动态选择模型实例（使用 `app/lib/model.ts` 的工厂函数）。

### 3. 消息状态行 (Message Status Line)
- **位置**: 消息内容上方 (`message...........message` 之上)。
- **内容**: `[model_name] [first_token_latency]`。
    - `model_name`: 生成该消息的模型名称（如 `Ling-1T`）。
    - `first_token_latency`: 首字延迟（ms）。

## 技术实现方案

### 1. 状态管理 (Zustand Store)
创建一个 `useModelStore`：
```typescript
interface ModelStore {
  modelId: string;
  systemPrompt: string;
  temperature: number;
  setModelId: (id: string) => void;
  setSystemPrompt: (prompt: string) => void;
  setTemperature: (temp: number) => void;
}
```

### 2. 前端组件改造
- **`components/model-config.tsx`**:
    - 连接 `useModelStore`。
    - 引入 `useThread` (来自 assistant-ui) 检测 `messages.length`。
    - 实现 Tooltip 和 Disabled 样式。
- **`app/assistant.tsx`**:
    - 在 `AssistantChatTransport` 的 `body` 中注入 store 中的 config。
- **`components/assistant-ui/thread.tsx`**:
    - 修改 `AssistantMessage` 组件。
    - 在 `MessagePrimitive.Root` 内部，`MessagePrimitive.Parts` 之前插入状态行 Header。
    - 状态数据来源：
        - `model_name`: 从 message metadata 获取（需后端返回）。
        - `latency`: 尝试使用 assistant-ui 的 `run` 状态或自定义计时逻辑。

### 3. 后端改造
- **`app/api/chat/route.ts`**:
    - 从 `req.json()` 读取 `modelId`, `systemPrompt`, `temperature`。
    - 将这些参数传入 `simpleGraph.stream` 的 `configurable` 字段。
- **`app/lib/assistants/simple-graph.ts`**:
    - 修改 `callModel` 节点。
    - 从 `config` 中读取参数。
    - 使用 `createChatModel(config.modelId, { temperature: config.temperature })` 动态创建模型。
    - 在 System Prompt 逻辑中，将 `config.systemPrompt` 插入到 `messages` 数组的最前面（或者使用 `SystemMessage`）。
    - 在返回的 `AIMessageChunk` 中，尝试附带 `model_name` 到 metadata 中。

## 待办事项 (TODO)

1. [ ] 创建 `lib/store.ts` (Zustand)。
2. [ ] 改造 `components/model-config.tsx` 实现参数绑定与禁用逻辑。
3. [ ] 改造 `app/assistant.tsx` 传递参数。
4. [ ] 改造 `app/lib/assistants/simple-graph.ts` 支持动态模型与参数。
5. [ ] 改造 `app/api/chat/route.ts` 传递 Config。
6. [ ] 改造 `components/assistant-ui/thread.tsx` 实现消息状态行。
