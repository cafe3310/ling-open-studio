# 2026-02-10-23-46-开发日志-优化ModelWeb流水线展示与预览交互体验

## 1. 背景 (Background)

在 Model Web (网页生成助手) 的快速迭代中，我们发现了一些用户体验和稳定性的关键缺陷：
1. **展示混乱**：多个生成块内容重复累加，缺乏层次感。
2. **预览交互失效**：生成的 HTML 中的锚点链接（如 `#features`）在 iframe 中会导致整个页面刷新或路径错误。
3. **开发噪音**：控制台频繁报出跨域请求警告。

## 2. 来源文档 (Source)
- [[2026-02-10-23-28-开发日志-修复ModelWeb工具执行循环与反馈逻辑]]

## 3. 主要工作 (Major Changes)

### 3.1 极致的流水线状态 UI (Staged Pipeline UI)
- **节点识别与稳定渲染**：
    - 在后端 `initial-gen.ts` 和 `refine-gen.ts` 中为每个节点产出的消息分配了**稳定且唯一的 ID**（如 `web-gen-idea-${taskId}`）。
    - **原理**：稳定 ID 解决了 `assistant-ui` 在流式接收 LangGraph `messages` 快照时产生的“块重复”和“内容累加”问题。
- **UI 视觉重构**：
    - `WebMarkdownText` 现在展示为带有图标和进度条的状态块。
    - **自动展开**：当前正在运行的节点会自动展开详情，生成完成后收起（用户可手动切换）。
    - **状态标签**：根据元数据自动映射为“需求规划”、“视觉方案”、“代码实现”等阶段。

### 3.2 预览页面交互修复 (Preview Patch)
- **锚点点击拦截**：在 `WebPreview` 中，动态向 iframe 的 `srcDoc` 注入补丁脚本。
    - **功能**：拦截所有以 `#` 开头的链接，通过 `scrollIntoView({ behavior: 'smooth' })` 实现平滑滚动，并阻止默认的导航行为，防止了预览页面的异常刷新。
- **跨域安全配置**：在 `next.config.ts` 中配置 `experimental.allowedDevOrigins`，解决了开发环境下 iframe 通信引发的 `Cross origin request detected` 报错。

### 3.3 稳定性修复 (Stability)
- **修复无限循环**：解决了 `WebMarkdownText` 中由于返回新对象字面量导致的 `getSnapshot should be cached` React 无限重渲染错误。
- **修复重复工具调用**：在 `ToolCallRenderer` 中引入 `localExecutionCache`，解决了静默模式下由于无法查询线程历史导致的自动化逻辑反复触发问题。

## 4. 遇到的问题与修正 (Issues & Fixes)

- **streamMode 权衡**：
    - **尝试**：曾尝试将 `streamMode` 改为 `updates` 以减少冗余数据。
    - **结果**：导致 `toUIMessageStream` 无法解析流内容，界面空白。
    - **修正**：回退至 `messages` 模式，通过**消息 ID 唯一化**从根本上解决 UI 上的重复渲染问题。

## 5. 后续计划 (Next Steps)

- [ ] 开始 **Model Write** 助手的实现。
- [ ] 优化 `WebArchitect` 生成代码的性能（压缩、精简 Prompt）。
