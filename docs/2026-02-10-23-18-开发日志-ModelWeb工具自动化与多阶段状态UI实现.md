# 2026-02-10-23-18-开发日志-ModelWeb工具自动化与多阶段状态UI实现

## 1. 背景 (Background)

为了提升 Model Web (网页生成助手) 的“自主构建”体验，用户提出了两个核心需求：
1. **工具调用自动化**：模型输出的写文件等工具块应自动执行，无需用户手动点击“运行”。
2. **界面状态流化**：隐藏冗长的生成原文和工具详情，转而展示清晰的节点进度（如“设计生成中”、“规划已完成”），并支持点击展开查看原文。

## 2. 主要工作 (Major Changes)

### 2.1 工具调用全自动执行
- **`ToolCallRenderer` 增强**：
    - 新增 `autoApprove` 属性。当检测到消息生成完毕且存在未执行的工具调用时，组件会在 300ms 延迟后自动触发执行。
    - **闭环反馈**：修正了 `silent` 模式下的逻辑。现在即使在静默模式下，执行结果也会自动通过 `aui.thread().append` 回传给后端，确保 LangGraph 能够感知工具状态并继续后续节点。
- **UI 极致简化**：
    - 新增 `hideDetails` 属性。开启后隐藏复杂的代码块参数展示，仅显示一个包含图标和工具名称的“胶囊状”标签。

### 2.2 多阶段状态展示 (Staged UI)
- **Graph 逻辑对齐**：
    - 修改了 `initial-gen.ts` 和 `refine-gen.ts`。现在 `idea_expander`、`style_director` 和 `code_generator` 节点都会返回独立的 `AIMessage`。
    - 引入 `metadata.langgraph_node`，用于标识当前消息所属的逻辑阶段。
- **折叠式状态渲染器 (`WebMarkdownText`)**：
    - 完全重构了 Web 专用的文本渲染逻辑。
    - **逻辑映射**：将节点名映射为用户友好的中文标签（规划、设计、代码生成、优化）。
    - **状态联动**：实时展示“生成中...”或“已完成”。
    - **交互设计**：默认隐藏原文，提供“展开/收起原文”按钮。

### 2.3 Web 助手配置更新
- 在 `apps/studio/src/components/assistants/web-architect/thread.tsx` 中，为 `ToolCallRenderer` 默认开启了 `autoApprove={true}`、`silent={true}` 和 `hideDetails={true}`。

## 3. 遇到的问题与修正 (Issues & Fixes)

- **无限循环渲染 (Infinite Loop)**：
    - **问题**：在 `WebMarkdownText` 中，由于 `useAuiState` 选择器返回了一个新对象字面量，触发了 React 的无限重渲染报错。
    - **修正**：拆分了 `useAuiState` 调用，使其分别返回 `content`、`status` 和 `nodeName` 的原始字符串值。
- **Graph 消息丢失**：
    - **问题**：初始只有最后一个节点会显示在 UI 中。
    - **修正**：通过在每个中间节点显式返回 `messages: [response]` 解决。

## 4. 后续计划 (Next Steps)

- [ ] 优化 `Filesystem` 详情面板，支持在文件列表直接打开预览。
- [ ] 开始开发 **Model Write** 助手（辅助写作）。
- [ ] 增强 `WebArchitect` 的多文件生成能力（目前主要针对 index.html）。
